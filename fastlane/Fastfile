# fastlane/Fastfile
require "base64"
require "tempfile"
require "securerandom"

default_platform(:ios)

ROOT_DIR = File.expand_path("..", __dir__)
ENV["SPACESHIP_CONNECT_API_IN_HOUSE"] ||= "false"

# -------------------------------------------------
# ðŸ”‘  Build App Store Connect API-key hash
# -------------------------------------------------
def app_store_api_key_hash
  api_key_id = ENV["APP_STORE_CONNECT_API_KEY_ID"]
  issuer_id  = ENV["APP_STORE_CONNECT_API_ISSUER_ID"] || ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"]
  key_base64 = ENV["APP_STORE_CONNECT_API_KEY_BASE64"]
  raw_key    = ENV["APP_STORE_CONNECT_API_KEY"]

  UI.user_error!("APP_STORE_CONNECT_API_KEY_ID and APP_STORE_CONNECT_API_ISSUER_ID must be set") \
    if api_key_id.to_s.empty? || issuer_id.to_s.empty?

  UI.user_error!("Either APP_STORE_CONNECT_API_KEY_BASE64 or APP_STORE_CONNECT_API_KEY must be set") \
    if key_base64.to_s.empty? && raw_key.to_s.empty?

  {
    key_id:    api_key_id,
    issuer_id: issuer_id,
    key:       key_base64.to_s.empty? ? raw_key : Base64.decode64(key_base64),
    in_house:  false
  }
end

# -------------------------------------------------
# ðŸ“¦  Export options (no more broken exportOptions.plist)
# -------------------------------------------------
def ios_export_options
  app_identifier = ENV["APP_IDENTIFIER"]
  profile_name   = ENV["IOS_PROVISIONING_PROFILE_NAME"]
  team_id        = ENV["APPLE_TEAM_ID"]

  opts = {
    method:                         "app-store",
    teamID:                         team_id,
    manageAppVersionAndBuildNumber: true,
    uploadSymbols:                  true,
    uploadBitcode:                  false,
    compileBitcode:                 true,
    stripSwiftSymbols:              true
  }

  if profile_name.to_s.empty? || app_identifier.to_s.empty?
    # Let Xcode handle signing if we don't have both
    opts[:signingStyle] = "automatic"
  else
    # Fully manual mapping: one app id â†’ one profile
    opts[:signingStyle] = "manual"
    opts[:provisioningProfiles] = {
      app_identifier => profile_name
    }
  end

  opts
end

# -------------------------------------------------
# ðŸ“¦  Shared Xcode build options
# -------------------------------------------------
def ios_build_options
  workspace_path = File.join(ROOT_DIR, "ios", "JunoNative.xcworkspace")
  project_path   = File.join(ROOT_DIR, "ios", "JunoNative.xcodeproj")

  has_workspace  = File.exist?(workspace_path)
  has_project    = File.exist?(project_path)

  UI.user_error!("No workspace or project found in ios/") unless has_workspace || has_project

  {
    workspace:         has_workspace ? workspace_path : nil,
    project:           has_workspace ? nil            : project_path,
    scheme:            "JunoNative",
    configuration:     "Release",
    clean:             true,
    output_directory:  File.join(ROOT_DIR, "fastlane", "build", "ios"),
    output_name:       ENV["IOS_OUTPUT_NAME"] || "JunoNative.ipa",
    export_options:    ios_export_options,
    result_bundle:     true,
    buildlog_path:     File.join(ROOT_DIR, "fastlane", "logs"),
    export_xcargs:     "DEVELOPMENT_TEAM=#{ENV['APPLE_TEAM_ID']}"
  }.compact
end

# =================================================
# ðŸš€  Lanes
# =================================================
platform :ios do
  # ---------- Prep helpers ----------
  desc "Run unit tests for the Juno DSP core (CMake)"
  lane :dsp_tests do
    sh("cmake -S . -B fastlane/build/cmake -DCMAKE_BUILD_TYPE=Debug")
    sh("cmake --build fastlane/build/cmake --config Debug --target juno_tests")
    sh("ctest --test-dir fastlane/build/cmake --output-on-failure")
  end

  desc "Compile native C++ DSP engine"
  lane :compile_dsp_engine do
    build_dir = File.join(ROOT_DIR, "fastlane", "build", "cmake")
    sh("cmake -S #{ROOT_DIR} -B #{build_dir} -DCMAKE_BUILD_TYPE=Release")
    sh("cmake --build #{build_dir} --config Release")
  end

  desc "Generate / compile React-Native TurboModules"
  lane :compile_turbo_modules do
    script = File.join(ROOT_DIR, "scripts", "compile-turbo-modules.sh")
    UI.user_error!("Missing #{script}") unless File.exist?(script)
    sh("bash #{script}")
  end

  private_lane :install_cocoapods do
    ios_dir   = File.join(ROOT_DIR, "ios")
    podfile   = File.join(ios_dir, "Podfile")
    UI.user_error!("Podfile missing in ios/") unless File.exist?(podfile)

    Dir.chdir(ios_dir) do
      sh("bundle exec pod install --repo-update")
    end
  end

  private_lane :prepare_build_assets do
    compile_dsp_engine
    compile_turbo_modules
  end

  private_lane :compile_swift_sources do
    ws = File.join(ROOT_DIR, "ios", "JunoNative.xcworkspace")
    pr = File.join(ROOT_DIR, "ios", "JunoNative.xcodeproj")

    xcpretty = system("which xcpretty >/dev/null 2>&1")
    pretty   = xcpretty ? " | xcpretty --no-color" : ""

    cmd =
      if File.exist?(ws)
        %Q[xcodebuild -workspace "#{ws}" -scheme JunoNative -configuration Release -sdk iphoneos -destination 'generic/platform=iOS' CODE_SIGNING_ALLOWED=YES]
      elsif File.exist?(pr)
        %Q[xcodebuild -project "#{pr}" -scheme JunoNative -configuration Release -sdk iphoneos -destination 'generic/platform=iOS' CODE_SIGNING_ALLOWED=YES]
      else
        UI.user_error!("No xcworkspace/xcodeproj found")
      end

    sh("set -o pipefail && #{cmd}#{pretty}")
  end

  # ---------- Local build ----------
  desc "Local release build (no TestFlight upload)"
  lane :build do
    prepare_build_assets
    install_cocoapods
    compile_swift_sources
    build_app(ios_build_options)
  end

  # -------------------------------------------------
  # ðŸ”  Verification (API key + p12 + profile)
  # -------------------------------------------------
  desc "Verify ASC credentials, p12 & provisioning profile"
  lane :verify_appstore_connect do
    UI.header("ðŸ” Verifying ASC credentials, certificate & profile")

    %w[
      APPLE_ID
      APP_IDENTIFIER
      APPLE_TEAM_ID
      APP_STORE_CONNECT_API_KEY_ID
      APP_STORE_CONNECT_API_ISSUER_ID
      APP_STORE_CONNECT_API_KEY_BASE64
      IOS_DIST_CERT_BASE64
      IOS_DIST_CERT_PASSWORD
    ].each do |v|
      UI.user_error!("Missing #{v}") if ENV[v].to_s.empty?
    end

    # 1) ASC authentication --------------------------------------------------
    api_key = app_store_api_key_hash
    require "spaceship"
    token = Spaceship::ConnectAPI::Token.create(**api_key)
    Spaceship::ConnectAPI.token = token

    apps = Spaceship::ConnectAPI::App.all
    UI.success("âœ… Authenticated â€” #{apps.size} apps in this account")

    if (bundle_id = ENV["APP_IDENTIFIER"]).to_s != ""
      found = apps.find { |a| a.bundle_id == bundle_id }
      if found
        UI.success("âœ… Found app #{found.name} (#{bundle_id})")
      else
        UI.important("âš ï¸ No ASC app with bundle id #{bundle_id}")
      end
    end

    # 2) Validate p12 structure ---------------------------------------------
    UI.header("ðŸ” Verifying distribution certificate (.p12)")
    decoded = Base64.decode64(ENV["IOS_DIST_CERT_BASE64"])
    UI.user_error!("Decoded p12 is empty") if decoded.to_s.empty?

    Tempfile.create(["dist", ".p12"]) do |tmp|
      tmp.binmode
      tmp.write(decoded)
      tmp.flush

      sh("openssl pkcs12 -in '#{tmp.path}' -nokeys -passin pass:#{ENV['IOS_DIST_CERT_PASSWORD']} -info >/dev/null 2>&1")
    end
    UI.success("âœ… p12 structure and password are valid")

    # 3) Provisioning profile via sigh --------------------------------------
    UI.header("ðŸ§¾ Verifying provisioning profile via sigh")

    profile_path = sigh(
      app_identifier: ENV["APP_IDENTIFIER"],
      api_key:        api_key,
      adhoc:          false,
      readonly:       false,
      skip_install:   true
    )

    # Keep these in ENV so build/export can use them
    ENV["SIGH_PROFILE_PATH"]          = profile_path
    ENV["IOS_PROVISIONING_PROFILE_NAME"] = File.basename(profile_path.to_s, ".mobileprovision")

    UI.success("âœ… Provisioning profile downloaded: #{ENV['IOS_PROVISIONING_PROFILE_NAME']}")
    UI.success("ðŸŽ‰ Verification completed.")
  end

  # ---------- CI lane ----------
  desc "CI: build & upload to TestFlight"
  lane :ios_ci do
    # 1) Verify chain (ASC + p12 + profile)
    verify_appstore_connect

    # 2) Ensure profile name is wired for exportOptions
    if ENV["IOS_PROVISIONING_PROFILE_NAME"].to_s.empty? && ENV["SIGH_PROFILE_PATH"].to_s != ""
      ENV["IOS_PROVISIONING_PROFILE_NAME"] = File.basename(ENV["SIGH_PROFILE_PATH"], ".mobileprovision")
    end

    # 3) Build pipeline
    prepare_build_assets
    install_cocoapods
    compile_swift_sources
    build_app(ios_build_options)

    # 4) Upload to TestFlight
    upload_to_testflight(
      api_key:        app_store_api_key_hash,
      app_identifier: ENV["APP_IDENTIFIER"],
      team_id:        ENV["APPLE_TEAM_ID"],
      skip_waiting_for_build_processing: false,
      distribute_external:              false
    )
  end
end
