# fastlane/Fastfile
# ============================================================
# JunoNative ‚Äì deterministic CI Fastlane pipeline
# Converts static library ‚Üí iOS Application at build time
# ============================================================

default_platform(:ios)

require "fileutils"
require "tmpdir"
require "base64"
require "securerandom"
require "shellwords"

ROOT_DIR = File.expand_path("..", __dir__)
IOS_DIR  = File.join(ROOT_DIR, "ios")

# ------------------------------------------------------------
# Helpers
# ------------------------------------------------------------

def sh_ci(cmd)
  UI.message("‚Üí #{cmd}")
  sh(cmd)
end

def sh_ci_allow_fail(cmd, label:)
  sh_ci(cmd)
rescue => e
  UI.important("‚ö†Ô∏è  #{label} failed (non-fatal): #{e.message}")
end

# ------------------------------------------------------------
# iOS
# ------------------------------------------------------------

platform :ios do
  # ==========================================================
  # MAIN CI LANE
  # ==========================================================
  desc "Full iOS CI: convert project ‚Üí build app ‚Üí (archive when signed)"
  lane :ios_ci do
    UI.header("üöÄ JunoNative iOS CI")

    ENV["RCT_NEW_ARCH_ENABLED"] ||= "1"

    prepare_environment
    install_cocoapods

    # üîë CRITICAL STEP
    # Convert static library ‚Üí application BEFORE touching schemes
    convert_project_to_app

    # Now it is safe to patch project + scheme
    patch_project_and_scheme

    preflight_build

    UI.success("üéâ iOS CI completed successfully (preflight build)")
  end

  # ==========================================================
  # ENV / SETUP
  # ==========================================================
  private_lane :prepare_environment do
    UI.header("üîß Preparing environment")

    ENV["APP_IDENTIFIER"] ||= "com.pulsr.junonative"
    ENV["APPLE_TEAM_ID"]  ||= "UNKNOWN_TEAM"
    ENV["SCHEME"]         ||= "JunoNative"

    UI.message("Bundle ID: #{ENV['APP_IDENTIFIER']}")
    UI.message("Scheme:    #{ENV['SCHEME']}")
  end

  # ==========================================================
  # COCOAPODS
  # ==========================================================
  private_lane :install_cocoapods do
    UI.header("üì¶ Installing CocoaPods")

    Dir.chdir(IOS_DIR) do
      sh_ci "RCT_NEW_ARCH_ENABLED=1 bundle exec pod install --repo-update"
    end

    UI.success("‚úÖ CocoaPods installed")
  end

  # ==========================================================
  # PROJECT CONVERSION
  # ==========================================================
  private_lane :convert_project_to_app do
    UI.header("üîÅ Converting Xcode target to Application")

    script = File.join(ROOT_DIR, "scripts", "ci", "fix_ios_project.rb")

    unless File.exist?(script)
      UI.user_error!("Missing script: #{script}")
    end

    sh_ci "bundle exec ruby #{script}"

    UI.success("‚úÖ Project converted to iOS Application")
  end

  # ==========================================================
  # PROJECT + SCHEME PATCHING
  # ==========================================================
  private_lane :patch_project_and_scheme do
    UI.header("üß∞ Patching Xcode project + scheme")

    sh_ci_allow_fail(
      "bundle exec ruby #{File.join(ROOT_DIR, 'scripts', 'ci', 'fix_xcodeproj.rb')}",
      label: "fix_xcodeproj.rb"
    )

    sh_ci_allow_fail(
      "bundle exec ruby #{File.join(ROOT_DIR, 'scripts', 'ci', 'ensure_shared_scheme.rb')}",
      label: "ensure_shared_scheme.rb"
    )

    UI.success("‚úÖ Project / scheme patch phase finished")
  end

  # ==========================================================
  # PREFLIGHT BUILD (NO SIGNING)
  # ==========================================================
  private_lane :preflight_build do
    UI.header("üß™ Preflight build (no code signing)")

    workspace = File.join(IOS_DIR, "JunoNative.xcworkspace")
    scheme    = ENV["SCHEME"]

    unless File.exist?(workspace)
      UI.user_error!("Workspace not found: #{workspace}")
    end

    cmd = <<~CMD
      set -o pipefail && xcodebuild \
        -workspace "#{workspace}" \
        -scheme "#{scheme}" \
        -configuration Release \
        -sdk iphoneos \
        -destination 'generic/platform=iOS' \
        CODE_SIGNING_ALLOWED=NO \
        CODE_SIGNING_REQUIRED=NO \
        RCT_NEW_ARCH_ENABLED=1 \
        build
    CMD

    sh_ci_allow_fail(cmd, label: "xcodebuild preflight")

    UI.success("‚úÖ Preflight build executed")
  end

  # ==========================================================
  # OPTIONAL: ARCHIVE (ONLY WHEN CERTS ARE PRESENT)
  # ==========================================================
  desc "Archive app (requires signing)"
  lane :archive_app do
    UI.header("üì¶ Archiving iOS app")

    workspace = File.join(IOS_DIR, "JunoNative.xcworkspace")
    scheme    = ENV["SCHEME"]
    archive   = File.join(ROOT_DIR, "fastlane", "build", "ios", "JunoNative.xcarchive")

    FileUtils.mkdir_p(File.dirname(archive))

    sh_ci <<~CMD
      set -o pipefail && xcodebuild \
        -workspace "#{workspace}" \
        -scheme "#{scheme}" \
        -configuration Release \
        -sdk iphoneos \
        -destination 'generic/platform=iOS' \
        -archivePath "#{archive}" \
        archive
    CMD

    validate_archive!(archive)

    UI.success("‚úÖ Archive produced: #{archive}")
  end

  # ==========================================================
  # ARCHIVE VALIDATION
  # ==========================================================
  private_lane :validate_archive! do |archive_path|
    UI.header("üîç Validating archive")

    apps_dir = File.join(archive_path, "Products", "Applications")

    unless Dir.exist?(apps_dir)
      UI.user_error!(
        "Archive is missing Products/Applications. " \
        "This usually means the target is still a library."
      )
    end

    apps = Dir.glob(File.join(apps_dir, "*.app"))
    UI.user_error!("No .app found in archive") if apps.empty?

    UI.success("‚úÖ Archive contains app: #{File.basename(apps.first)}")
  end
end
