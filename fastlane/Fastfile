# ------------------------------------------------------------
# Fastfile
# JunoNative iOS CI Pipeline
#
# - Headless (GitHub Actions)
# - Static library ‚Üí Application conversion
# - React Native New Architecture enabled
# - No local Mac required
# ------------------------------------------------------------

default_platform(:ios)

require "base64"
require "fileutils"
require "shellwords"
require "securerandom"

ROOT_DIR = File.expand_path("..", __dir__)
IOS_DIR  = File.join(ROOT_DIR, "ios")

# ------------------------------------------------------------
# Helpers
# ------------------------------------------------------------

def env_any(*keys)
  keys.each do |k|
    v = ENV[k]
    return v unless v.nil? || v.strip.empty?
  end
  ""
end

def ensure_any!(label, *keys)
  v = env_any(*keys)
  UI.user_error!("Missing #{label}. Provide one of: #{keys.join(', ')}") if v.empty?
  v
end

# ------------------------------------------------------------
# iOS Platform
# ------------------------------------------------------------

platform :ios do

  # ==========================================================
  # MAIN CI LANE
  # ==========================================================
  desc "CI: Convert project ‚Üí App, build, archive, export IPA"
  lane :ios_ci do
    UI.header("üöÄ JunoNative iOS CI")

    # --- Required environment ---
    app_identifier = ensure_any!("App Identifier", "APP_IDENTIFIER")
    team_id        = ensure_any!("Apple Team ID", "APPLE_TEAM_ID")

    ENV["RCT_NEW_ARCH_ENABLED"] = "1"
    ENV["CI"] = "true"

    # --------------------------------------------------------
    # 1. Install Pods (New Architecture)
    # --------------------------------------------------------
    install_cocoapods

    # --------------------------------------------------------
    # 2. Convert static lib ‚Üí iOS Application
    # --------------------------------------------------------
    convert_project_to_app

    # --------------------------------------------------------
    # 3. Normalize build settings (CI-safe)
    # --------------------------------------------------------
    fix_xcodeproj_settings

    # --------------------------------------------------------
    # 4. Preflight compile (no signing)
    # --------------------------------------------------------
    compile_app_no_signing

    # --------------------------------------------------------
    # 5. Archive + Export IPA (signing required)
    # --------------------------------------------------------
    archive_and_export_ipa(
      app_identifier: app_identifier,
      team_id: team_id
    )

    UI.success("üéâ iOS CI pipeline completed successfully")
  end

  # ==========================================================
  # COCOAPODS
  # ==========================================================
  private_lane :install_cocoapods do
    UI.header("üì¶ Installing CocoaPods (New Arch enabled)")
    Dir.chdir(IOS_DIR) do
      sh("RCT_NEW_ARCH_ENABLED=1 bundle exec pod install --repo-update")
    end
  end

  # ==========================================================
  # PROJECT CONVERSION
  # ==========================================================
  private_lane :convert_project_to_app do
    UI.header("üîß Converting Xcode project to Application")
    sh("bundle exec ruby #{File.join(ROOT_DIR, 'scripts', 'ci', 'fix_ios_project.rb')}")
  end

  # ==========================================================
  # PROJECT NORMALIZATION
  # ==========================================================
  private_lane :fix_xcodeproj_settings do
    UI.header("üß∞ Normalizing Xcode project settings")

    sh("bundle exec ruby #{File.join(ROOT_DIR, 'scripts', 'ci', 'fix_xcodeproj.rb')}")

    begin
      sh("bundle exec ruby #{File.join(ROOT_DIR, 'scripts', 'ci', 'ensure_shared_scheme.rb')}")
    rescue
      UI.important("‚ö†Ô∏è Scheme already valid or auto-generated by Xcode")
    end
  end

  # ==========================================================
  # PRE-FLIGHT BUILD (NO SIGNING)
  # ==========================================================
  private_lane :compile_app_no_signing do
    UI.header("üß™ Preflight build (no signing)")

    workspace = File.join(IOS_DIR, "JunoNative.xcworkspace")

    sh <<~CMD
      set -o pipefail
      xcodebuild \
        -workspace "#{workspace}" \
        -scheme JunoNative \
        -configuration Release \
        -sdk iphoneos \
        -destination 'generic/platform=iOS' \
        CODE_SIGNING_ALLOWED=NO \
        CODE_SIGNING_REQUIRED=NO \
        RCT_NEW_ARCH_ENABLED=1 \
        build
    CMD
  end

  # ==========================================================
  # ARCHIVE + EXPORT IPA
  # ==========================================================
  private_lane :archive_and_export_ipa do |options|
    UI.header("üì¶ Archiving + Exporting IPA")

    app_identifier = options[:app_identifier]
    team_id        = options[:team_id]

    cert_base64 = ensure_any!(
      "iOS Distribution Certificate",
      "IOS_DIST_CERT_BASE64",
      "IOS_CERT_P12_BASE64"
    )

    cert_password = ensure_any!(
      "Certificate Password",
      "IOS_DIST_CERT_PASSWORD",
      "IOS_CERT_PASSWORD"
    )

    profile_base64 = ensure_any!(
      "Provisioning Profile",
      "IOS_PROFILE_BASE64",
      "IOS_PROVISIONING_PROFILE_BASE64"
    )

    # --- Paths ---
    build_dir   = File.join(ROOT_DIR, "fastlane", "build", "ios")
    archive     = File.join(build_dir, "JunoNative.xcarchive")
    export_dir  = File.join(build_dir, "export")

    FileUtils.mkdir_p(export_dir)

    # --- Keychain ---
    keychain = "ios-build.keychain"
    keychain_pw = SecureRandom.hex(16)

    delete_keychain(name: keychain) rescue nil
    create_keychain(
      name: keychain,
      password: keychain_pw,
      unlock: true,
      timeout: 3600
    )

    # --- Import cert ---
    p12_path = File.join(Dir.tmpdir, "dist.p12")
    File.write(p12_path, Base64.decode64(cert_base64))

    import_certificate(
      certificate_path: p12_path,
      certificate_password: cert_password,
      keychain_name: keychain,
      keychain_password: keychain_pw
    )

    # --- Provisioning profile ---
    profile_path = File.join(Dir.tmpdir, "profile.mobileprovision")
    File.write(profile_path, Base64.decode64(profile_base64))
    sh("mkdir -p ~/Library/MobileDevice/Provisioning\\ Profiles")
    sh("cp #{profile_path} ~/Library/MobileDevice/Provisioning\\ Profiles/")

    # --- Archive ---
    workspace = File.join(IOS_DIR, "JunoNative.xcworkspace")

    sh <<~CMD
      set -o pipefail
      xcodebuild archive \
        -workspace "#{workspace}" \
        -scheme JunoNative \
        -configuration Release \
        -sdk iphoneos \
        -archivePath "#{archive}" \
        DEVELOPMENT_TEAM=#{team_id} \
        PRODUCT_BUNDLE_IDENTIFIER=#{app_identifier} \
        CODE_SIGN_STYLE=Manual \
        RCT_NEW_ARCH_ENABLED=1
    CMD

    # --- Export options ---
    export_plist = File.join(export_dir, "ExportOptions.plist")
    File.write(export_plist, <<~PLIST)
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <dict>
        <key>method</key><string>app-store</string>
        <key>signingStyle</key><string>manual</string>
        <key>teamID</key><string>#{team_id}</string>
        <key>stripSwiftSymbols</key><true/>
        <key>compileBitcode</key><false/>
      </dict>
      </plist>
    PLIST

    # --- Export IPA ---
    sh <<~CMD
      set -o pipefail
      xcodebuild -exportArchive \
        -archivePath "#{archive}" \
        -exportPath "#{export_dir}" \
        -exportOptionsPlist "#{export_plist}"
    CMD

    UI.success("‚úÖ IPA exported successfully")
  end
end
