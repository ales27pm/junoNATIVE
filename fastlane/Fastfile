# fastlane/Fastfile
require "plist"
require "base64"
require "tempfile"
require "securerandom"

default_platform :ios
ROOT_DIR = File.expand_path("..", __dir__)
ENV["SPACESHIP_CONNECT_API_IN_HOUSE"] ||= "false"

# -------------------------
# üîë  App Store API helper
# -------------------------
def app_store_api_key_hash
  key_id     = ENV.fetch("APP_STORE_CONNECT_API_KEY_ID")
  issuer_id  = ENV["APP_STORE_CONNECT_API_ISSUER_ID"] || ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"]
  key_b64    = ENV["APP_STORE_CONNECT_API_KEY_BASE64"]
  raw_key    = ENV["APP_STORE_CONNECT_API_KEY"]

  UI.user_error!("Set APP_STORE_CONNECT_API_ISSUER_ID") if issuer_id.to_s.empty?
  UI.user_error!("Provide APP_STORE_CONNECT_API_KEY_BASE64 or APP_STORE_CONNECT_API_KEY") if key_b64.to_s.empty? && raw_key.to_s.empty?

  {
    key_id:    key_id,
    issuer_id: issuer_id,
    key:       key_b64.to_s.empty? ? raw_key : Base64.decode64(key_b64),
    in_house:  false
  }
end

# -------------------------
# üì¶  Xcode build options
# -------------------------
def ios_build_options
  ws = File.join(ROOT_DIR, "ios", "JunoNative.xcworkspace")
  pr = File.join(ROOT_DIR, "ios", "JunoNative.xcodeproj")
  UI.user_error!("No workspace nor project under ios/") unless File.exist?(ws) || File.exist?(pr)

  export_plist = File.join(ROOT_DIR, "ios", "exportOptions.plist")
  UI.user_error!("Missing exportOptions.plist") unless File.exist?(export_plist)
  xo = Plist.parse_xml(export_plist) || {}
  xo["teamID"] = ENV["APPLE_TEAM_ID"] unless ENV["APPLE_TEAM_ID"].to_s.empty?

  if ENV["IOS_PROVISIONING_PROFILE_NAME"].to_s.empty?
    xo["signingStyle"] = "automatic"
  else
    xo["signingStyle"] = "manual"
    xo["provisioningProfiles"] ||= {}
    xo["provisioningProfiles"][ENV["APP_IDENTIFIER"]] = ENV["IOS_PROVISIONING_PROFILE_NAME"]
  end

  {
    workspace:         File.exist?(ws) ? ws : nil,
    project:           File.exist?(ws) ? nil : pr,
    scheme:            "JunoNative",
    configuration:     "Release",
    clean:             true,
    output_directory:  File.join(ROOT_DIR, "fastlane", "build", "ios"),
    output_name:       ENV["IOS_OUTPUT_NAME"] || "JunoNative.ipa",
    export_options:    xo,
    result_bundle:     true,
    buildlog_path:     File.join(ROOT_DIR, "fastlane", "logs"),
    export_xcargs:     "DEVELOPMENT_TEAM=#{ENV['APPLE_TEAM_ID']}"
  }.compact
end

# =================================================
# üöÄ  Lanes
# =================================================
platform :ios do
  # (utility lanes omitted for brevity ‚Ä¶)

  # --------------------------------------------
  # üîç  Verification lane (used by CI as well)
  # --------------------------------------------
  desc "Verify ASC creds, p12 & provisioning profile"
  lane :verify_appstore_connect do
    UI.header("üîç Verifying ASC credentials, certificate & profile")
    %w[APPLE_ID APP_IDENTIFIER APPLE_TEAM_ID APP_STORE_CONNECT_API_KEY_ID
       APP_STORE_CONNECT_API_ISSUER_ID APP_STORE_CONNECT_API_KEY_BASE64
       IOS_DIST_CERT_BASE64 IOS_DIST_CERT_PASSWORD].each do |v|
      UI.user_error!("Missing #{v}") if ENV[v].to_s.empty?
    end

    api_key = app_store_api_key_hash
    require "spaceship"
    Spaceship::ConnectAPI.token = Spaceship::ConnectAPI::Token.create(**api_key)
    UI.success("‚úÖ Authenticated ‚Äî #{Spaceship::ConnectAPI::App.all.count} apps in this account")

    # ----- p12 import -----
    kc_pwd   = ENV["KEYCHAIN_PASSWORD"] || "fastlane"
    kc_name  = "fastlane_tmp_#{SecureRandom.hex(4)}"
    keychain = create_keychain(
      name: kc_name,
      password: kc_pwd,
      default_keychain: false,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false
    )

    Tempfile.create(["cert", ".p12"]) do |f|
      f.binmode; f.write(Base64.decode64(ENV["IOS_DIST_CERT_BASE64"])); f.flush
      sh("openssl pkcs12 -in #{f.path.shellescape} -nokeys -passin pass:#{ENV['IOS_DIST_CERT_PASSWORD']} -info >/dev/null 2>&1")
      import_certificate(keychain_name: kc_name,
                         certificate_path: f.path,
                         certificate_password: ENV["IOS_DIST_CERT_PASSWORD"])
    end
    UI.success("‚úÖ Distribution certificate imported")

    # ----- provisioning profile via sigh -----
    path = sigh(app_identifier: ENV["APP_IDENTIFIER"],
                api_key: api_key,
                adhoc: false,
                readonly: false,
                skip_install: true)

    path ||= Actions.lane_context[SharedValues::SIGH_PROFILE_PATH]
    ENV["IOS_PROVISIONING_PROFILE_NAME"] = File.basename(path, ".mobileprovision")
    ENV["SIGH_PROFILE_PATH"]             = path
    UI.success("‚úÖ Provisioning profile saved as #{ENV['IOS_PROVISIONING_PROFILE_NAME']}")
  ensure
    delete_keychain(name: keychain) if keychain
  end

  # --------------------------------------------
  # üèó  CI lane ‚Äì build & upload to TestFlight
  # --------------------------------------------
  desc "CI: build & upload to TestFlight"
  lane :ios_ci do
    verify_appstore_connect

    prepare_build_assets
    install_cocoapods
    compile_swift_sources
    build_app(ios_build_options)

    upload_to_testflight(
      api_key:        app_store_api_key_hash,
      app_identifier: ENV["APP_IDENTIFIER"],
      team_id:        ENV["APPLE_TEAM_ID"],
      skip_waiting_for_build_processing: false,
      distribute_external:              false
    )
  end
end
