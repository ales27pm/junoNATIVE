require "fileutils"

ROOT_DIR = File.expand_path("..", __dir__)
IOS_OUTPUT_DIR = ENV.fetch("IOS_ARTIFACT_DIR", File.join(ROOT_DIR, "fastlane/build/ios"))
ANDROID_OUTPUT_DIR = ENV.fetch("ANDROID_ARTIFACT_DIR", File.join(ROOT_DIR, "fastlane/build/android"))
ANDROID_BUNDLE_ROOT = ENV.fetch("ANDROID_BUNDLE_OUTPUT_DIR", File.join(ROOT_DIR, "android/app/build/outputs/bundle"))
ANDROID_BUNDLE_PATH = ENV["ANDROID_RELEASE_BUNDLE_PATH"]

def resolve_android_bundle(build_type)
  return File.expand_path(ANDROID_BUNDLE_PATH, ROOT_DIR) if ANDROID_BUNDLE_PATH

  normalized_build_type = build_type.to_s
  normalized_build_type[0] = normalized_build_type[0].downcase if normalized_build_type.length.positive?

  candidate_directories = [
    normalized_build_type,
    build_type.to_s,
    build_type.to_s.downcase
  ].uniq

  bundle_dir = candidate_directories.map { |dir| File.join(ANDROID_BUNDLE_ROOT, dir) }
    .find { |dir| Dir.exist?(dir) && Dir.glob(File.join(dir, "*.aab")).any? }

  UI.user_error!(
    "No Android App Bundle found. Checked: #{candidate_directories.map { |dir| File.join(ANDROID_BUNDLE_ROOT, dir) }.join(', ')}"
  ) unless bundle_dir

  Dir.glob(File.join(bundle_dir, "*.aab")).max_by { |path| File.mtime(path) }
end

default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :release do
    FileUtils.mkdir_p(IOS_OUTPUT_DIR)

    sh("bash scripts/compile-turbo-modules.sh")

    build_app(
      workspace: "ios/JunoNative.xcworkspace",
      scheme: "JunoNative",
      export_method: "app-store",
      output_directory: IOS_OUTPUT_DIR,
      output_name: ENV.fetch("IOS_OUTPUT_NAME", "JunoNative.ipa")
    )

    upload_to_testflight
  end
end

platform :android do
  desc "Build and upload to Play Console internal track"
  lane :release do |options|
    FileUtils.mkdir_p(ANDROID_OUTPUT_DIR)

    sh("bash scripts/compile-turbo-modules.sh")

    build_type = options[:build_type] || ENV.fetch("ANDROID_BUILD_TYPE", "Release")

    gradle(
      task: "bundle",
      build_type: build_type,
      project_dir: "android"
    )

    release_bundle = resolve_android_bundle(build_type)

    archived_bundle = File.join(
      ANDROID_OUTPUT_DIR,
      ENV.fetch("ANDROID_BUNDLE_NAME", File.basename(release_bundle))
    )
    FileUtils.cp(release_bundle, archived_bundle)

    upload_to_play_store(track: "internal", aab: archived_bundle)
  end
end
