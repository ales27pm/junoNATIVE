default_platform(:ios)

require "fileutils"
require "shellwords"
require "securerandom"
require "tmpdir"
require "base64"

ROOT_DIR = File.expand_path("..", __dir__)
IOS_DIR  = File.join(ROOT_DIR, "ios")

# -------------------------------------------------
# Helpers
# -------------------------------------------------

def env!(key)
  value = ENV[key]
  UI.user_error!("Missing ENV #{key}") if value.to_s.empty?
  value
end

def optional_env(key, default)
  ENV[key].to_s.empty? ? default : ENV[key]
end

# -------------------------------------------------
# iOS
# -------------------------------------------------

platform :ios do

  desc "Full CI: patch project ‚Üí build app ‚Üí archive ‚Üí export IPA"
  lane :ios_ci do
    UI.header("üöÄ JunoNative iOS CI")

    ENV["RCT_NEW_ARCH_ENABLED"] = "1"

    prepare_environment
    install_cocoapods
    convert_project_to_app
    fix_xcodeproj_settings
    build_no_signing
    archive_and_export

    UI.success("üéâ iOS CI finished successfully")
  end

  # -------------------------------------------------
  # Environment prep
  # -------------------------------------------------

  private_lane :prepare_environment do
    UI.header("üß± Preparing environment")

    sh("node --version")
    sh("ruby --version")
    sh("bundle --version")

    FileUtils.mkdir_p("fastlane/build/ios")
  end

  # -------------------------------------------------
  # CocoaPods
  # -------------------------------------------------

  private_lane :install_cocoapods do
    UI.header("üì¶ Installing CocoaPods (New Architecture)")

    Dir.chdir(IOS_DIR) do
      sh("RCT_NEW_ARCH_ENABLED=1 bundle exec pod install --repo-update")
    end
  end

  # -------------------------------------------------
  # Convert static lib ‚ûú app
  # -------------------------------------------------

  private_lane :convert_project_to_app do
    UI.header("üîß Converting Xcode project to iOS Application")

    sh("bundle exec ruby scripts/ci/fix_ios_project.rb")
  end

  # -------------------------------------------------
  # Fix Xcode project + scheme
  # -------------------------------------------------

  private_lane :fix_xcodeproj_settings do
    UI.header("üß∞ Fixing Xcode project & shared scheme")

    begin
      sh("bundle exec ruby scripts/ci/fix_xcodeproj.rb")
    rescue
      UI.important("fix_xcodeproj.rb skipped")
    end

    begin
      sh("bundle exec ruby scripts/ci/ensure_shared_scheme.rb")
    rescue
      UI.important("ensure_shared_scheme.rb skipped")
    end
  end

  # -------------------------------------------------
  # Build (no signing, sanity check)
  # -------------------------------------------------

  private_lane :build_no_signing do
    UI.header("üß™ Building app (no code signing)")

    workspace = File.join(IOS_DIR, "JunoNative.xcworkspace")

    cmd = %Q[
      set -o pipefail &&
      xcodebuild
        -workspace "#{workspace}"
        -scheme JunoNative
        -configuration Release
        -sdk iphoneos
        -destination "generic/platform=iOS"
        CODE_SIGNING_ALLOWED=NO
        CODE_SIGNING_REQUIRED=NO
        RCT_NEW_ARCH_ENABLED=1
    ]

    sh(cmd)
  end

  # -------------------------------------------------
  # Archive + export IPA
  # -------------------------------------------------

  private_lane :archive_and_export do
    UI.header("üì¶ Archiving & exporting IPA")

    app_identifier = env!("APP_IDENTIFIER")
    team_id        = env!("APPLE_TEAM_ID")
    profile_name   = env!("PROFILE_NAME")

    build_dir   = File.join(ROOT_DIR, "fastlane/build/ios")
    archive     = File.join(build_dir, "JunoNative.xcarchive")
    export_dir  = File.join(build_dir, "export")

    FileUtils.rm_rf(archive)
    FileUtils.rm_rf(export_dir)

    workspace = File.join(IOS_DIR, "JunoNative.xcworkspace")

    sh(%Q[
      set -o pipefail &&
      xcodebuild
        -workspace "#{workspace}"
        -scheme JunoNative
        -configuration Release
        -sdk iphoneos
        -destination "generic/platform=iOS"
        -archivePath "#{archive}"
        archive
        DEVELOPMENT_TEAM=#{team_id}
        CODE_SIGN_STYLE=Manual
        PROVISIONING_PROFILE_SPECIFIER=#{Shellwords.escape(profile_name)}
        RCT_NEW_ARCH_ENABLED=1
    ])

    validate_archive!(archive)

    export_plist = File.join(build_dir, "ExportOptions.plist")
    File.write(export_plist, <<~PLIST)
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
       "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <dict>
        <key>method</key>
        <string>app-store</string>
        <key>signingStyle</key>
        <string>manual</string>
        <key>teamID</key>
        <string>#{team_id}</string>
        <key>provisioningProfiles</key>
        <dict>
          <key>#{app_identifier}</key>
          <string>#{profile_name}</string>
        </dict>
      </dict>
      </plist>
    PLIST

    sh(%Q[
      set -o pipefail &&
      xcodebuild
        -exportArchive
        -archivePath "#{archive}"
        -exportPath "#{export_dir}"
        -exportOptionsPlist "#{export_plist}"
    ])

    UI.success("üì± IPA exported to #{export_dir}")
  end

  # -------------------------------------------------
  # Validation
  # -------------------------------------------------

  def validate_archive!(archive_path)
    apps_dir = File.join(archive_path, "Products", "Applications")
    UI.user_error!("‚ùå Archive missing Products/Applications") unless Dir.exist?(apps_dir)

    apps = Dir.glob("#{apps_dir}/*.app")
    UI.user_error!("‚ùå No .app found in archive") if apps.empty?

    UI.success("‚úÖ Archive contains #{File.basename(apps.first)}")
  end

end
