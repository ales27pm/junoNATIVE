default_platform(:ios)

require "base64"
require "tmpdir"
require "fileutils"

def require_env!(name)
  v = ENV[name]
  UI.user_error!("Missing ENV['#{name}']") if v.nil? || v.strip.empty?
  v
end

def write_tmp_bytes(filename, bytes)
  dir = File.join(Dir.mktmpdir, "fastlane_ci")
  FileUtils.mkdir_p(dir)
  path = File.join(dir, filename)
  File.binwrite(path, bytes)
  path
end

platform :ios do
  desc "CI build + upload to TestFlight using App Store Connect API key"
  lane :ios_ci do
    require_env!("APP_IDENTIFIER")
    require_env!("APPLE_TEAM_ID")
    require_env!("APP_STORE_CONNECT_API_KEY_ID")
    require_env!("APP_STORE_CONNECT_API_KEY_ISSUER_ID")
    require_env!("APP_STORE_CONNECT_API_KEY_BASE64")
    require_env!("IOS_DIST_CERT_BASE64")
    require_env!("IOS_DIST_CERT_PASSWORD")
    require_env!("IOS_APPSTORE_PROFILE_NAME")

    # Decode .p8 (accept base64 or raw)
    raw = ENV["APP_STORE_CONNECT_API_KEY_BASE64"].to_s.strip
    decoded = nil
    begin
      decoded = Base64.decode64(raw)
      decoded = nil unless decoded.include?("BEGIN PRIVATE KEY")
    rescue
      decoded = nil
    end
    decoded ||= raw

    p8_path = write_tmp_bytes("AuthKey.p8", decoded.encode("utf-8"))

    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_filepath: p8_path
    )

    # Import Distribution cert (p12)
    p12_path = write_tmp_bytes("dist.p12", Base64.decode64(ENV["IOS_DIST_CERT_BASE64"]))

    import_certificate(
      certificate_path: p12_path,
      certificate_password: ENV["IOS_DIST_CERT_PASSWORD"]
    )

    # Fetch + install provisioning profile (by *name*)
    sigh(
      app_identifier: ENV["APP_IDENTIFIER"],
      provisioning_name: ENV["IOS_APPSTORE_PROFILE_NAME"],
      readonly: true,
      skip_install: false,
      api_key: api_key
    )

    build_app(
      workspace: ENV.fetch("IOS_WORKSPACE", "ios/JunoNative.xcworkspace"),
      scheme: ENV.fetch("IOS_SCHEME", "JunoNative"),
      configuration: "Release",
      export_method: "app-store",
      export_options: {
        signingStyle: "manual",
        teamID: ENV["APPLE_TEAM_ID"],
        provisioningProfiles: {
          ENV["APP_IDENTIFIER"] => ENV["IOS_APPSTORE_PROFILE_NAME"]
        },
        compileBitcode: false
      }
    )

    upload_to_testflight(
      api_key: api_key,
      ipa: lane_context[SharedValues::IPA_OUTPUT_PATH],
      skip_waiting_for_build_processing: true
    )
  end
end
