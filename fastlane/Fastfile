# fastlane/Fastfile
# JunoNative iOS â€“ deterministic CI pipeline (Application, not static lib)

default_platform(:ios)

require "tmpdir"
require "fileutils"
require "securerandom"
require "base64"

ROOT_DIR = File.expand_path("..", __dir__)
IOS_DIR  = File.join(ROOT_DIR, "ios")

# ------------------------------------------------------------------------------
# Helpers
# ------------------------------------------------------------------------------

def env!(key)
  value = ENV[key]
  UI.user_error!("Missing ENV #{key}") if value.nil? || value.strip.empty?
  value
end

def optional_env(key, default)
  ENV[key].nil? || ENV[key].empty? ? default : ENV[key]
end

# ------------------------------------------------------------------------------
# iOS
# ------------------------------------------------------------------------------

platform :ios do
  desc "Full CI: convert project â†’ build app â†’ archive â†’ validate"
  lane :ios_ci do
    UI.header("ðŸš€ JunoNative iOS CI")

    # --------------------------------------------------------------------------
    # Environment
    # --------------------------------------------------------------------------
    ENV["RCT_NEW_ARCH_ENABLED"] = "1"
    ENV["CI"] = "true"

    app_identifier = optional_env("APP_IDENTIFIER", "com.pulsr.junonative")
    team_id        = optional_env("APPLE_TEAM_ID", "UNKNOWN")
    scheme         = "JunoNative"
    workspace      = File.join(IOS_DIR, "JunoNative.xcworkspace")

    # --------------------------------------------------------------------------
    # Dependencies
    # --------------------------------------------------------------------------
    prepare_build_assets
    install_cocoapods

    # --------------------------------------------------------------------------
    # ðŸ”‘ CRITICAL STEP
    # Convert static library â†’ real iOS Application
    # --------------------------------------------------------------------------
    convert_project_to_app

    # --------------------------------------------------------------------------
    # Build sanity check (no signing)
    # --------------------------------------------------------------------------
    preflight_build(
      workspace: workspace,
      scheme: scheme
    )

    # --------------------------------------------------------------------------
    # Archive (no signing, but REAL app archive)
    # --------------------------------------------------------------------------
    archive_app(
      workspace: workspace,
      scheme: scheme,
      app_identifier: app_identifier
    )

    UI.success("ðŸŽ‰ iOS CI pipeline completed successfully")
  end

  # ============================================================================
  # Private lanes
  # ============================================================================

  private_lane :prepare_build_assets do
    UI.header("ðŸ§± Preparing native assets (DSP / TurboModules)")
    # Keep deterministic â€“ no-op unless you explicitly enable
    UI.message("DSP / TurboModules assumed prebuilt or handled elsewhere")
  end

  private_lane :install_cocoapods do
    UI.header("ðŸ“¦ Installing CocoaPods (New Architecture enabled)")
    Dir.chdir(IOS_DIR) do
      sh("RCT_NEW_ARCH_ENABLED=1 bundle exec pod install --repo-update")
    end
    UI.success("Pods installed")
  end

  # --------------------------------------------------------------------------
  # ðŸ”§ Project conversion
  # --------------------------------------------------------------------------
  private_lane :convert_project_to_app do
    UI.header("ðŸ”§ Converting Xcode project to iOS Application")

    script = File.join(ROOT_DIR, "scripts", "ci", "fix_ios_project.rb")
    UI.user_error!("Missing #{script}") unless File.exist?(script)

    sh("bundle exec ruby #{script}")

    UI.success("Xcode project converted to application target")
  end

  # --------------------------------------------------------------------------
  # ðŸ§ª Build without signing
  # --------------------------------------------------------------------------
  private_lane :preflight_build do |options|
    workspace = options[:workspace]
    scheme    = options[:scheme]

    UI.header("ðŸ§ª Preflight build (no code signing)")

    sh <<~CMD
      set -o pipefail && \
      xcodebuild \
        -workspace "#{workspace}" \
        -scheme "#{scheme}" \
        -configuration Release \
        -sdk iphoneos \
        -destination 'generic/platform=iOS' \
        CODE_SIGNING_ALLOWED=NO \
        CODE_SIGNING_REQUIRED=NO \
        CODE_SIGNING_IDENTITY="" \
        DEVELOPMENT_TEAM="" \
        build
    CMD

    UI.success("Preflight build passed")
  end

  # --------------------------------------------------------------------------
  # ðŸ“¦ Archive (REAL .app inside xcarchive)
  # --------------------------------------------------------------------------
  private_lane :archive_app do |options|
    workspace      = options[:workspace]
    scheme         = options[:scheme]
    app_identifier = options[:app_identifier]

    UI.header("ðŸ“¦ Archiving iOS application")

    build_dir   = File.join(ROOT_DIR, "fastlane", "build", "ios")
    archive_path = File.join(build_dir, "#{scheme}.xcarchive")

    FileUtils.rm_rf(build_dir)
    FileUtils.mkdir_p(build_dir)

    sh <<~CMD
      set -o pipefail && \
      xcodebuild \
        -workspace "#{workspace}" \
        -scheme "#{scheme}" \
        -configuration Release \
        -sdk iphoneos \
        -destination 'generic/platform=iOS' \
        -archivePath "#{archive_path}" \
        CODE_SIGNING_ALLOWED=NO \
        CODE_SIGNING_REQUIRED=NO \
        CODE_SIGNING_IDENTITY="" \
        DEVELOPMENT_TEAM="" \
        archive
    CMD

    validate_archive!(archive_path)

    UI.success("Archive created with valid .app")
  end

  # --------------------------------------------------------------------------
  # ðŸ” Validation
  # --------------------------------------------------------------------------
  private_lane :validate_archive! do |archive_path|
    UI.header("ðŸ” Validating archive")

    apps_dir = File.join(archive_path, "Products", "Applications")
    UI.user_error!("Archive missing Products/Applications") unless Dir.exist?(apps_dir)

    apps = Dir.glob(File.join(apps_dir, "*.app"))
    UI.user_error!("No .app found in archive") if apps.empty?

    UI.message("Found app: #{File.basename(apps.first)}")
  end
end
