default_platform(:ios)

ROOT_DIR = File.expand_path("..", __dir__)
BUILD_DIR = File.join(ROOT_DIR, "fastlane", "build", "ios")

def env!(key)
  v = ENV[key]
  UI.user_error!("Missing ENV #{key}") if v.to_s.empty?
  v
end

platform :ios do
  before_all do
    ENV["CI"] = "true"
    ENV["RCT_NEW_ARCH_ENABLED"] = "1"
    FileUtils.mkdir_p(BUILD_DIR)
  end

  ########################################
  # App Store Connect API (NO LOGIN)
  ########################################
  private_lane :asc_api do
    app_store_connect_api_key(
      key_id: env!("APP_STORE_CONNECT_API_KEY_ID"),
      issuer_id: env!("APP_STORE_CONNECT_API_KEY_ISSUER_ID"),
      key_content: Base64.decode64(env!("APP_STORE_CONNECT_API_KEY_BASE64")),
      is_key_content_base64: false,
      duration: 1200
    )
  end

  ########################################
  # Install signing assets
  ########################################
  private_lane :install_signing do
    create_keychain(
      name: "ios-build.keychain",
      password: "ci",
      unlock: true,
      timeout: 3600
    )

    p12 = File.join(Dir.tmpdir, "cert.p12")
    profile = File.join(Dir.tmpdir, "profile.mobileprovision")

    File.write(p12, Base64.decode64(env!("IOS_DIST_CERT_BASE64")))
    File.write(profile, Base64.decode64(env!("IOS_PROFILE_BASE64")))

    import_certificate(
      certificate_path: p12,
      certificate_password: env!("IOS_DIST_CERT_PASSWORD"),
      keychain_name: "ios-build.keychain"
    )

    sh("mkdir -p ~/Library/MobileDevice/Provisioning\\ Profiles")
    sh("cp #{profile} ~/Library/MobileDevice/Provisioning\\ Profiles/")
  end

  ########################################
  # Pods
  ########################################
  private_lane :install_pods do
    Dir.chdir("ios") do
      sh("RCT_NEW_ARCH_ENABLED=1 bundle exec pod install --repo-update")
    end
  end

  ########################################
  # Build + Archive
  ########################################
  private_lane :archive_app do
    archive_path = File.join(BUILD_DIR, "JunoNative.xcarchive")

    sh(%Q[
      set -o pipefail &&
      xcodebuild archive \
        -workspace ios/JunoNative.xcworkspace \
        -scheme JunoNative \
        -configuration Release \
        -destination 'generic/platform=iOS' \
        -archivePath "#{archive_path}" \
        DEVELOPMENT_TEAM=#{env!("APPLE_TEAM_ID")} \
        CODE_SIGN_STYLE=Manual \
        SKIP_INSTALL=NO \
        BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
        RCT_NEW_ARCH_ENABLED=1 \
      | xcpretty
    ])

    UI.user_error!("Archive missing") unless File.exist?(archive_path)
  end

  ########################################
  # Export IPA
  ########################################
  private_lane :export_ipa do
    ipa_dir = File.join(BUILD_DIR, "ipa")

    FileUtils.mkdir_p(ipa_dir)

    export_plist = File.join(BUILD_DIR, "exportOptions.plist")

    File.write(export_plist, <<~PLIST)
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <dict>
        <key>method</key>
        <string>app-store</string>
        <key>signingStyle</key>
        <string>manual</string>
        <key>stripSwiftSymbols</key>
        <true/>
        <key>uploadBitcode</key>
        <false/>
        <key>compileBitcode</key>
        <false/>
      </dict>
      </plist>
    PLIST

    sh(%Q[
      set -o pipefail &&
      xcodebuild -exportArchive \
        -archivePath "#{BUILD_DIR}/JunoNative.xcarchive" \
        -exportOptionsPlist "#{export_plist}" \
        -exportPath "#{ipa_dir}" \
      | xcpretty
    ])

    ipa = Dir["#{ipa_dir}/*.ipa"].first
    UI.user_error!("IPA not generated") unless ipa
  end

  ########################################
  # Upload to TestFlight
  ########################################
  private_lane :upload_testflight do
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false
    )
  end

  ########################################
  # MAIN CI LANE
  ########################################
  lane :ios_ci do
    asc_api
    install_signing
    install_pods
    archive_app
    export_ipa
    upload_testflight
  end
end
