platform :ios, '15.1'
source 'https://cdn.cocoapods.org/'

root_path         = File.expand_path('..', __dir__)
node_modules_path = File.expand_path('../node_modules', __dir__)

require_relative '../node_modules/react-native/scripts/react_native_pods'
require_relative '../node_modules/@react-native-community/cli-platform-ios/native_modules'

project 'JunoNative.xcodeproj'

target 'JunoNative' do
  config = use_native_modules!

  use_react_native!(
    path: config[:reactNativePath],
    hermes_enabled: true,
    fabric_enabled: true,
    app_path: root_path
  )

  post_install do |installer|
    react_native_post_install(installer)

    # 1️⃣ All Pods must NEVER be installable products
    installer.pods_project.targets.each do |t|
      t.build_configurations.each do |c|
        c.build_settings['SKIP_INSTALL'] = 'YES'
        c.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.1'
      end
    end

    # 2️⃣ The APP target must ALWAYS be installable
    installer.aggregate_targets.each do |agg|
      agg.user_project.targets.each do |t|
        next unless t.name == 'JunoNative'

        t.build_configurations.each do |c|
          c.build_settings['SKIP_INSTALL'] = 'NO'
          c.build_settings['INSTALL_PATH'] = '$(LOCAL_APPS_DIR)'
          c.build_settings['PRODUCT_NAME'] ||= 'JunoNative'
        end
      end
    end
  end
end
