platform :ios, '15.1'
source 'https://cdn.cocoapods.org/'

root_path           = File.expand_path('..', __dir__)
node_modules_path   = File.expand_path('../node_modules', __dir__)

unless File.directory?(node_modules_path)
  Pod::UI.puts 'React Native dependencies not found. Run `npm ci` before installing pods.'
  raise Pod::Informative, "Missing node_modules at #{node_modules_path}; install JavaScript dependencies and retry."
end

react_native_pods = File.join(node_modules_path, 'react-native', 'scripts', 'react_native_pods.rb')
cli_platform_ios  = File.join(node_modules_path, '@react-native-community', 'cli-platform-ios', 'native_modules.rb')

unless File.exist?(react_native_pods)
  Pod::UI.puts 'React Native pods script not found. Ensure `react-native` is installed in node_modules.'
  raise Pod::Informative, "Expected react_native_pods.rb at #{react_native_pods}"
end

unless File.exist?(cli_platform_ios)
  Pod::UI.puts 'React Native CLI iOS native_modules.rb not found. Ensure @react-native-community/cli-platform-ios is installed.'
  raise Pod::Informative, "Expected native_modules.rb at #{cli_platform_ios}"
end

require react_native_pods
require cli_platform_ios

project 'JunoNative.xcodeproj'

target 'JunoNative' do
  config = use_native_modules!

  use_react_native!(
    path:           config[:reactNativePath],
    hermes_enabled: true,
    fabric_enabled: true,
    app_path:       root_path
  )

  post_install do |installer|
    # --- React Native / CocoaPods standard hooks (keep yours if you have them) ---
    # If you already have react_native_post_install(installer) or similar,
    # keep it and place the SKIP_INSTALL enforcement AFTER it.
    #
    # Example:
    # react_native_post_install(installer)

    # 1) Force ALL Pods (dependencies) to be non-installable (prevents "Generic Archive")
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['SKIP_INSTALL'] = 'YES'
      end
    end

    # 2) Force MAIN APP target to be installable so the archive contains Products/Applications/*.app
    installer.aggregate_targets.each do |aggregate|
      aggregate.user_project.targets.each do |target|
        next unless target.name == 'JunoNative' # MUST match your main app target name exactly

        target.build_configurations.each do |config|
          next unless config.name == 'Release' # archive uses Release in your workflow

          config.build_settings['SKIP_INSTALL'] = 'NO'
          config.build_settings['INSTALL_PATH'] = '$(LOCAL_APPS_DIR)'
        end
      end
    end
  end
