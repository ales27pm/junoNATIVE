platform :ios, '13.0'

source 'https://github.com/CocoaPods/Specs.git'

require 'json'
require 'open3'

root_path = File.expand_path('..', __dir__)
node_modules_path = File.expand_path('../node_modules', __dir__)

unless File.directory?(node_modules_path)
  Pod::UI.puts 'React Native dependencies not found. Run `npm ci` before installing pods.'
  raise Pod::Informative, "Missing node_modules at #{node_modules_path}; install JavaScript dependencies and retry."
end

react_native_pods = File.join(node_modules_path, 'react-native', 'scripts', 'react_native_pods.rb')
cli_platform_ios  = File.join(node_modules_path, '@react-native-community', 'cli-platform-ios', 'native_modules.rb')

unless File.exist?(react_native_pods)
  Pod::UI.puts 'React Native pods script not found. Ensure `react-native` is installed in node_modules.'
  raise Pod::Informative, "Expected react_native_pods.rb at #{react_native_pods}"
end

unless File.exist?(cli_platform_ios)
  Pod::UI.puts 'React Native CLI iOS native_modules.rb not found. Ensure @react-native-community/cli-platform-ios is installed.'
  raise Pod::Informative, "Expected native_modules.rb at #{cli_platform_ios}"
end

require react_native_pods
require cli_platform_ios

def react_native_cli_entrypoint(node_modules_path)
  candidate = File.join(node_modules_path, '@react-native-community', 'cli', 'build', 'bin.js')
  return candidate if File.exist?(candidate)

  raise Pod::Informative, "React Native CLI not found in node_modules at #{node_modules_path}. Run `npm ci` and retry."
end

cli_entrypoint = react_native_cli_entrypoint(node_modules_path)

project 'JunoNative.xcodeproj'

target 'JunoNative' do
  # Drive use_native_modules via the actual React Native CLI at the repo root.
  config = use_native_modules!([
    'node',
    '-e',
    "process.chdir('#{root_path}');require('#{cli_entrypoint}').run()"
  ])

  use_react_native!(
    :path => config[:reactNativePath],
    :hermes_enabled => true,
    :fabric_enabled => true,
    :app_path => root_path
  )

  post_install do |installer|
    react_native_post_install(installer)

    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        # Keep iOS 13+ minimum and modern build settings
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
      end
    end
  end
end
