name: iOS Manual Deploy (TestFlight)

on:
  workflow_dispatch:
    inputs:
      changelog:
        description: "Release notes (shown in TestFlight)"
        required: false
        default: ""

concurrency:
  group: ios-testflight-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-upload:
    runs-on: macos-14
    timeout-minutes: 60

    env:
      # --- Toolchain ---
      NODE_VERSION: "22"
      RUBY_VERSION: "3.2"

      # --- iOS build settings ---
      IOS_WORKSPACE: ios/JunoNative.xcworkspace
      IOS_SCHEME: JunoNative
      IOS_CONFIGURATION: Release

      ARCHIVE_PATH: ${{ runner.temp }}/JunoNative.xcarchive
      EXPORT_DIR: ${{ runner.temp }}/export
      EXPORT_OPTIONS_PLIST: ${{ runner.temp }}/ExportOptions.plist

      # --- App Store Connect API key files (generated at runtime) ---
      ASC_KEY_P8_PATH: ${{ runner.temp }}/AuthKey.p8
      ASC_KEY_JSON_PATH: ${{ runner.temp }}/asc_api_key.json

      # --- Required secrets (mapped into env for clarity) ---
      APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
      # Base64 of the entire .p8 file contents (recommended), OR raw .p8 text
      APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}

      # Base64 .p12 for Apple Distribution cert + its password
      IOS_DIST_CERT_BASE64: ${{ secrets.IOS_DIST_CERT_BASE64 }}
      IOS_DIST_CERT_PASSWORD: ${{ secrets.IOS_DIST_CERT_PASSWORD }}

      # The exact provisioning profile *name* in the Apple portal (ex: "match AppStore com.example.app")
      IOS_APPSTORE_PROFILE_NAME: ${{ secrets.IOS_APPSTORE_PROFILE_NAME }}

    steps:
      - name: ðŸ§¾ Checkout
        uses: actions/checkout@v4

      - name: ðŸ§° Setup Node.js (with Yarn cache)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: yarn
          cache-dependency-path: yarn.lock

      - name: ðŸ’Ž Setup Ruby (Bundler cache)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: ðŸ§ª Print toolchain versions
        run: |
          set -euo pipefail
          node -v
          corepack --version || true
          yarn -v || true
          ruby -v
          bundle -v
          xcodebuild -version

      - name: ðŸ“¦ Install JS deps
        run: |
          set -euo pipefail
          corepack enable || true

          if [ -f ".yarnrc.yml" ]; then
            yarn install --immutable
          else
            yarn install --frozen-lockfile
          fi

      - name: ðŸ§± CocoaPods install
        run: |
          set -euo pipefail
          cd ios
          bundle exec pod --version
          bundle exec pod install --repo-update

      - name: ðŸ”‘ Write App Store Connect API key files (p8 + json)
        run: |
          set -euo pipefail

          python3 - <<'PY'
          import base64, json, os, sys
          key_id = os.environ["APP_STORE_CONNECT_API_KEY_ID"]
          issuer = os.environ["APP_STORE_CONNECT_API_KEY_ISSUER_ID"]
          raw = os.environ["APP_STORE_CONNECT_API_KEY_BASE64"]
          p8_path = os.environ["ASC_KEY_P8_PATH"]
          json_path = os.environ["ASC_KEY_JSON_PATH"]

          # Accept either base64(.p8) or raw .p8 content.
          data = raw.strip().encode("utf-8")
          decoded = None
          try:
            decoded = base64.b64decode(data, validate=True)
            if b"BEGIN PRIVATE KEY" not in decoded:
              decoded = None
          except Exception:
            decoded = None

          if decoded is None:
            decoded = data

          with open(p8_path, "wb") as f:
            f.write(decoded)

          payload = {
            "key_id": key_id,
            "issuer_id": issuer,
            "key_filepath": p8_path
          }
          with open(json_path, "w", encoding="utf-8") as f:
            json.dump(payload, f)

          print(f"Wrote ASC p8:   {p8_path}")
          print(f"Wrote ASC json: {json_path}")
          PY

      - name: ðŸ” Import Apple Distribution certificate (.p12)
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ env.IOS_DIST_CERT_BASE64 }}
          p12-password: ${{ env.IOS_DIST_CERT_PASSWORD }}

      - name: âœ… Verify codesign identities
        run: |
          set -euo pipefail
          security find-identity -p codesigning -v || true

      - name: ðŸ“¥ Install provisioning profile (via fastlane sigh)
        run: |
          set -euo pipefail

          # sigh supports api_key_path and can install the profile (skip_install=false) :contentReference[oaicite:2]{index=2}
          bundle exec fastlane run sigh \
            app_identifier:"$APP_IDENTIFIER" \
            provisioning_name:"$IOS_APPSTORE_PROFILE_NAME" \
            readonly:true \
            skip_install:false \
            api_key_path:"$ASC_KEY_JSON_PATH"

          echo "Provisioning Profiles directory:"
          ls -lah "$HOME/Library/MobileDevice/Provisioning Profiles" || true

      - name: ðŸ§¾ Generate ExportOptions.plist
        run: |
          set -euo pipefail

          cat > "$EXPORT_OPTIONS_PLIST" <<PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>${APPLE_TEAM_ID}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${APP_IDENTIFIER}</key>
              <string>${IOS_APPSTORE_PROFILE_NAME}</string>
            </dict>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
          </dict>
          </plist>
          PLIST

          /usr/bin/plutil -lint "$EXPORT_OPTIONS_PLIST"

      - name: ðŸ—ï¸ Build archive
        run: |
          set -euo pipefail

          xcodebuild \
            -workspace "$IOS_WORKSPACE" \
            -scheme "$IOS_SCHEME" \
            -configuration "$IOS_CONFIGURATION" \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -archivePath "$ARCHIVE_PATH" \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="$IOS_APPSTORE_PROFILE_NAME" \
            clean archive

      - name: ðŸ“¦ Export IPA
        run: |
          set -euo pipefail

          rm -rf "$EXPORT_DIR"
          mkdir -p "$EXPORT_DIR"

          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$EXPORT_DIR" \
            -exportOptionsPlist "$EXPORT_OPTIONS_PLIST"

          echo "Export dir:"
          ls -lah "$EXPORT_DIR"

          IPA_PATH="$(find "$EXPORT_DIR" -maxdepth 2 -name '*.ipa' -print -quit)"
          if [ -z "$IPA_PATH" ]; then
            echo "ERROR: IPA not found in $EXPORT_DIR"
            exit 1
          fi

          echo "IPA_PATH=$IPA_PATH" >> "$GITHUB_ENV"
          echo "Found IPA: $IPA_PATH"

      - name: ðŸš€ Upload to TestFlight (Fastlane)
        run: |
          set -euo pipefail

          # upload_to_testflight supports api_key_path (JSON) :contentReference[oaicite:3]{index=3}
          bundle exec fastlane run upload_to_testflight \
            ipa:"$IPA_PATH" \
            api_key_path:"$ASC_KEY_JSON_PATH" \
            skip_waiting_for_build_processing:true \
            changelog:"${{ inputs.changelog }}"

      - name: ðŸ“Ž Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ${{ env.IPA_PATH }}
          if-no-files-found: error
