name: iOS Manual Deploy (App Store Connect / TestFlight)

on:
  workflow_dispatch:
    inputs:
      release_notes:
        description: "Release notes for TestFlight (optional)"
        required: false
        default: ""

jobs:
  ios_manual_deploy:
    runs-on: macos-14
    timeout-minutes: 60

    env:
      # --- Required secrets (set these in GitHub repo secrets) ---
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      # App Store Connect API key (p8) as BASE64 (single-line)
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}

      # Distribution cert (p12) as BASE64 and password
      IOS_DIST_CERT_BASE64: ${{ secrets.IOS_DIST_CERT_BASE64 }}
      IOS_DIST_CERT_PASSWORD: ${{ secrets.IOS_DIST_CERT_PASSWORD }}

      # Provisioning profile (.mobileprovision) as BASE64 (App Store profile)
      IOS_APPSTORE_PROFILE_BASE64: ${{ secrets.IOS_APPSTORE_PROFILE_BASE64 }}

      # Keychain password (can be empty but better set)
      KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}

      # --- Build config ---
      XCODE_WORKSPACE: ios/JunoNative.xcworkspace
      XCODE_SCHEME: JunoNative
      CONFIGURATION: Release

      # Optional: if you want to pin node
      NODE_VERSION: "22"

    steps:
      - name: ðŸ§¾ Checkout code
        uses: actions/checkout@v4

      - name: Compute build paths
        id: paths
        shell: bash
        run: |
          set -euo pipefail
          echo "export_options_plist=$RUNNER_TEMP/ExportOptions.plist" >> "$GITHUB_OUTPUT"
          echo "archive_path=$RUNNER_TEMP/JunoNative.xcarchive" >> "$GITHUB_OUTPUT"
          echo "archive_info_plist=$RUNNER_TEMP/JunoNative.xcarchive/Info.plist" >> "$GITHUB_OUTPUT"
          echo "export_dir=$RUNNER_TEMP/build" >> "$GITHUB_OUTPUT"

      - name: ðŸŸ© Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: ðŸ“¦ Install JS deps
        shell: bash
        run: |
          set -euo pipefail
          corepack enable
          yarn --version
          yarn install --frozen-lockfile

      - name: ðŸ’Ž Setup Ruby (Bundler cache)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: ðŸ§° Install CocoaPods
        shell: bash
        run: |
          set -euo pipefail
          cd ios
          bundle exec pod install --repo-update

      - name: ðŸ” Create temporary keychain
        shell: bash
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="$RUNNER_TEMP/ios-build.keychain-db"
          KEYCHAIN_PASSWORD="${KEYCHAIN_PASSWORD:-temp-pass}"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Make it the default for this job
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"

          # Allow codesign to access the keychain non-interactively
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> "$GITHUB_ENV"

      - name: ðŸªª Decode and import signing certificate (p12)
        shell: bash
        run: |
          set -euo pipefail
          CERT_P12="$RUNNER_TEMP/ios_dist.p12"
          echo "$IOS_DIST_CERT_BASE64" | base64 --decode > "$CERT_P12"

          security import "$CERT_P12" \
            -k "$KEYCHAIN_PATH" \
            -P "$IOS_DIST_CERT_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

      - name: ðŸ“„ Decode provisioning profile
        shell: bash
        run: |
          set -euo pipefail
          PP_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PP_DIR"

          PP_FILE="$RUNNER_TEMP/profile.mobileprovision"
          echo "$IOS_APPSTORE_PROFILE_BASE64" | base64 --decode > "$PP_FILE"

          # Extract UUID so Xcode can find it
          UUID=$(/usr/bin/security cms -D -i "$PP_FILE" | /usr/libexec/PlistBuddy -c 'Print:UUID' /dev/stdin)
          cp "$PP_FILE" "$PP_DIR/$UUID.mobileprovision"

          echo "PROFILE_UUID=$UUID" >> "$GITHUB_ENV"

      - name: ðŸ”‘ Decode App Store Connect API key (p8)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/asc"
          API_KEY_PATH="$RUNNER_TEMP/asc/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8"
          echo "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > "$API_KEY_PATH"
          chmod 600 "$API_KEY_PATH"
          echo "ASC_API_KEY_PATH=$API_KEY_PATH" >> "$GITHUB_ENV"

      - name: ðŸ—ï¸ Build archive (xcodebuild archive)
        shell: bash
        run: |
          set -euo pipefail

          ARCHIVE_PATH="$RUNNER_TEMP/JunoNative.xcarchive"

          # Ensure deterministic build output
          rm -rf "$ARCHIVE_PATH"

          xcodebuild \
            -workspace "$XCODE_WORKSPACE" \
            -scheme "$XCODE_SCHEME" \
            -configuration "$CONFIGURATION" \
            -sdk iphoneos \
            -archivePath "$ARCHIVE_PATH" \
            -allowProvisioningUpdates \
            -destination "generic/platform=iOS" \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            PRODUCT_BUNDLE_IDENTIFIER="$APP_IDENTIFIER" \
            archive | xcpretty

          test -d "$ARCHIVE_PATH"

      - name: ðŸ§¾ Create ExportOptions.plist (App Store)
        shell: bash
        run: |
          set -euo pipefail

          EXPORT_PLIST="$RUNNER_TEMP/ExportOptions.plist"

          cat > "$EXPORT_PLIST" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>destination</key>
            <string>export</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
            <key>teamID</key>
            <string>${APPLE_TEAM_ID}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${APP_IDENTIFIER}</key>
              <string>${PROFILE_UUID}</string>
            </dict>
          </dict>
          </plist>
          PLIST

          test -f "$EXPORT_PLIST"
          plutil -lint "$EXPORT_PLIST"

      - name: ðŸ“¤ Export IPA (xcodebuild -exportArchive)
        shell: bash
        run: |
          set -euo pipefail

          ARCHIVE_PATH="$RUNNER_TEMP/JunoNative.xcarchive"
          EXPORT_DIR="$RUNNER_TEMP/build"
          EXPORT_PLIST="$RUNNER_TEMP/ExportOptions.plist"

          rm -rf "$EXPORT_DIR"
          mkdir -p "$EXPORT_DIR"

          xcodebuild \
            -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$EXPORT_DIR" \
            -exportOptionsPlist "$EXPORT_PLIST" | xcpretty

          ls -la "$EXPORT_DIR"
          IPA_COUNT=$(find "$EXPORT_DIR" -maxdepth 1 -name "*.ipa" | wc -l | tr -d ' ')
          if [ "$IPA_COUNT" -lt 1 ]; then
            echo "No .ipa found in export dir"
            exit 1
          fi

      - name: ðŸš€ Upload to TestFlight (fastlane pilot)
        shell: bash
        env:
          RELEASE_NOTES: ${{ inputs.release_notes }}
        run: |
          set -euo pipefail

          EXPORT_DIR="$RUNNER_TEMP/build"
          IPA_PATH=$(find "$EXPORT_DIR" -maxdepth 1 -name "*.ipa" | head -n 1)

          # Build the API key JSON for fastlane from the decoded p8 path
          cat > "$RUNNER_TEMP/api_key.json" << JSON
          {
            "key_id": "${APP_STORE_CONNECT_API_KEY_ID}",
            "issuer_id": "${APP_STORE_CONNECT_API_KEY_ISSUER_ID}",
            "key": "$(cat "$ASC_API_KEY_PATH" | sed ':a;N;$!ba;s/\n/\\n/g')",
            "in_house": false
          }
          JSON

          bundle exec fastlane run pilot \
            api_key_path:"$RUNNER_TEMP/api_key.json" \
            ipa:"$IPA_PATH" \
            skip_waiting_for_build_processing:true \
            changelog:"$RELEASE_NOTES"

      - name: ðŸ“Ž Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-artifacts
          path: |
            ${{ steps.paths.outputs.export_options_plist }}
            ${{ steps.paths.outputs.archive_info_plist }}
            ${{ steps.paths.outputs.archive_path }}
            ${{ steps.paths.outputs.export_dir }}

      - name: ðŸ§¹ Cleanup keychain
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${KEYCHAIN_PATH:-}" ] && [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi
