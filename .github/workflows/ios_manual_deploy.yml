name: iOS Manual Deploy

on:
  workflow_dispatch:

jobs:
  ios_manual_deploy:
    runs-on: macos-15
    env:
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
      IOS_DIST_CERT_BASE64: ${{ secrets.IOS_DIST_CERT_BASE64 }}
      IOS_DIST_CERT_PASSWORD: ${{ secrets.IOS_DIST_CERT_PASSWORD }}
      IOS_PROFILE_BASE64: ${{ secrets.IOS_PROFILE_BASE64 }}
      KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      XCODE_WORKSPACE: ios/JunoNative.xcworkspace
      XCODE_SCHEME: JunoNative
      CONFIGURATION: Release
      NODE_VERSION: 22
      ARCHIVE_PATH: ${{ runner.temp }}/JunoNative.xcarchive
      EXPORT_DIR: ${{ runner.temp }}/build
      EXPORT_OPTIONS_PLIST: ${{ runner.temp }}/ExportOptions.plist
      PROFILE_PLIST: ${{ runner.temp }}/profile.plist
      XCODEBUILD_ARCHIVE_LOG: ${{ runner.temp }}/xcodebuild-archive.log
      XCODEBUILD_EXPORT_LOG: ${{ runner.temp }}/xcodebuild-export.log
      KEYCHAIN_PATH: ${{ runner.temp }}/ios-build.keychain-db
      PROFILE_UUID: 513a771a-d7e4-43d8-ab87-d1471af6bf0c  # From log; update if needed
      PROFILE_NAME: junoNATIVE
      ASC_DIR: ${{ runner.temp }}/asc
      ASC_API_KEY_PATH: ${{ runner.temp }}/asc/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Select Xcode 16
        run: |
          set -euo pipefail
          sudo xcode-select -s /Applications/Xcode_16.app
          xcodebuild -version

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Verify Yarn
        run: |
          corepack enable
          yarn --version || npm install -g yarn

      - name: Install JS Dependencies
        run: |
          set -euo pipefail
          if [ -f "yarn.lock" ]; then
            echo "Detected yarn.lock – using Yarn"
            yarn install --frozen-lockfile
          elif [ -f "package-lock.json" ]; then
            echo "Detected package-lock.json – using npm"
            npm ci
          else
            echo "No lockfile found, running fallback install"
            yarn install || npm install
          fi

      - name: Install CocoaPods Dependencies
        working-directory: ios
        run: pod install --repo-update

      - name: Setup Ruby and Bundler
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      - name: Import Apple Distribution Certificate
        run: |
          set -euo pipefail
          CERT_PATH="${{ runner.temp }}/dist.p12"
          echo "${{ env.IOS_DIST_CERT_BASE64 }}" | base64 --decode > "$CERT_PATH"
          security create-keychain -p "${{ env.KEYCHAIN_PASSWORD }}" "${{ env.KEYCHAIN_PATH }}"
          security default-keychain -s "${{ env.KEYCHAIN_PATH }}"
          security unlock-keychain -p "${{ env.KEYCHAIN_PASSWORD }}" "${{ env.KEYCHAIN_PATH }}"
          security import "$CERT_PATH" -k "${{ env.KEYCHAIN_PATH }}" -P "${{ env.IOS_DIST_CERT_PASSWORD }}" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${{ env.KEYCHAIN_PASSWORD }}" "${{ env.KEYCHAIN_PATH }}"

      - name: Import Provisioning Profile
        run: |
          set -euo pipefail
          echo "${{ env.IOS_PROFILE_BASE64 }}" | base64 --decode > "${{ env.PROFILE_PLIST }}"
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "${{ env.PROFILE_PLIST }}" ~/Library/MobileDevice/Provisioning\ Profiles/"${{ env.PROFILE_UUID }}".mobileprovision

      - name: Setup App Store Connect API Key
        run: |
          set -euo pipefail
          mkdir -p "${{ env.ASC_DIR }}"
          echo "${{ env.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > "${{ env.ASC_API_KEY_PATH }}"

      - name: Build and Archive iOS App
        run: |
          set -euo pipefail
          xcodebuild archive \
            -workspace "${{ env.XCODE_WORKSPACE }}" \
            -scheme "${{ env.XCODE_SCHEME }}" \
            -configuration "${{ env.CONFIGURATION }}" \
            -archivePath "${{ env.ARCHIVE_PATH }}" \
            -allowProvisioningUpdates | tee "${{ env.XCODEBUILD_ARCHIVE_LOG }}"

      - name: Export IPA
        run: |
          set -euo pipefail
          echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>
          <!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">
          <plist version=\"1.0\">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${{ env.APPLE_TEAM_ID }}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${{ env.APP_IDENTIFIER }}</key>
              <string>${{ env.PROFILE_UUID }}</string>
            </dict>
          </dict>
          </plist>" > "${{ env.EXPORT_OPTIONS_PLIST }}"

          xcodebuild -exportArchive \
            -archivePath "${{ env.ARCHIVE_PATH }}" \
            -exportPath "${{ env.EXPORT_DIR }}" \
            -exportOptionsPlist "${{ env.EXPORT_OPTIONS_PLIST }}" | tee "${{ env.XCODEBUILD_EXPORT_LOG }}"

      - name: Upload IPA to App Store Connect (or TestFlight)
        run: |
          set -euo pipefail
          # Use fastlane or xcrun altool for upload; assuming Fastfile has a lane for this
          bundle exec fastlane ios deploy_to_testflight  # Adjust lane name if needed

      - name: Upload Build Artifacts (on Failure)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-artifacts
          path: |
            ${{ runner.temp }}/ExportOptions.plist
            ${{ runner.temp }}/profile.plist
            ${{ env.ARCHIVE_PATH }}/Info.plist
            ${{ env.ARCHIVE_PATH }}
            ${{ env.EXPORT_DIR }}
            ${{ env.XCODEBUILD_ARCHIVE_LOG }}
            ${{ env.XCODEBUILD_EXPORT_LOG }}

      - name: Cleanup Keychain
        if: always()
        run: |
          set -euo pipefail
          if [ -n "${{ env.KEYCHAIN_PATH }}" ]; then
            security delete-keychain "${{ env.KEYCHAIN_PATH }}" || true
          fi
