name: iOS Forensic Build & Archive

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  ios-forensics:
    runs-on: macos-15

    env:
      XCODE_PROJECT: ios/JunoNative.xcodeproj
      XCODE_WORKSPACE: ios/JunoNative.xcworkspace
      SCHEME: JunoNative
      CONFIGURATION: Release

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode 16
        run: |
          sudo xcode-select -s /Applications/Xcode_16.app
          xcodebuild -version

      - name: Install Node deps
        run: |
          npm ci

      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods -v 1.16.2

      - name: Generate Workspace
        run: |
          cd ios
          pod install --repo-update

      - name: Target & Product Type Scan
        run: |
          xcodebuild -list -project "$XCODE_PROJECT"
          xcodebuild -showBuildSettings \
            -project "$XCODE_PROJECT" \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" | \
            awk -F' = ' '/PRODUCT_TYPE/ {print $2; exit}'

      - name: Enforce Application Scheme
        run: |
          PT=$(xcodebuild -showBuildSettings \
            -workspace "$XCODE_WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" | \
            awk -F' = ' '/PRODUCT_TYPE/ {print $2; exit}')

          echo "PRODUCT_TYPE=$PT"
          test "$PT" = "com.apple.product-type.application"

      - name: Archive (No xcpretty)
        run: |
          xcodebuild archive \
            -workspace "$XCODE_WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -archivePath "$RUNNER_TEMP/JunoNative.xcarchive" \
            CODE_SIGNING_ALLOWED=NO

      - name: Validate Archive Structure
        run: |
          test -d "$RUNNER_TEMP/JunoNative.xcarchive/Products/Applications"
