name: iOS Forensic Analysis

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  analyze-ios-project:
    runs-on: macos-15
    timeout-minutes: 45

    env:
      IOS_DIR: ios
      XCODE_PROJECT: ios/JunoNative.xcodeproj
      XCODE_WORKSPACE: ios/JunoNative.xcworkspace
      CONFIGURATION: Release
      NODE_VERSION: "22"

    steps:
      - name: ðŸ§¾ Checkout
        uses: actions/checkout@v4

      - name: ðŸ§° Select Xcode 16
        shell: bash
        run: |
          set -euo pipefail
          sudo xcode-select -s /Applications/Xcode_16.app
          xcodebuild -version

      - name: ðŸŸ© Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ§  Detect JS package manager
        id: pm
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "yarn.lock" ]; then
            echo "manager=yarn" >> "$GITHUB_OUTPUT"
          elif [ -f "package-lock.json" ]; then
            echo "manager=npm" >> "$GITHUB_OUTPUT"
          elif [ -f "pnpm-lock.yaml" ]; then
            echo "manager=pnpm" >> "$GITHUB_OUTPUT"
          else
            echo "manager=npm" >> "$GITHUB_OUTPUT"
          fi
          echo "Detected: ${{ steps.pm.outputs.manager }}"

      - name: ðŸ“¦ Install JS deps (lockfile-aware)
        shell: bash
        run: |
          set -euo pipefail
          corepack enable || true

          case "${{ steps.pm.outputs.manager }}" in
            yarn)
              yarn --version
              yarn install --frozen-lockfile
              ;;
            pnpm)
              corepack prepare pnpm@latest --activate
              pnpm --version
              pnpm install --frozen-lockfile
              ;;
            npm)
              node --version
              npm --version
              if [ -f "package-lock.json" ]; then
                npm ci
              else
                npm install
              fi
              ;;
          esac

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: ðŸ’Ž Install CocoaPods + xcpretty
        shell: bash
        run: |
          set -euo pipefail
          gem install cocoapods -N
          gem install xcpretty -N
          pod --version
          xcpretty --version || true

      - name: ðŸ§© Generate workspace (pod install)
        shell: bash
        run: |
          set -euo pipefail
          cd "${IOS_DIR}"
          pod install --repo-update
          cd -
          test -f "${XCODE_WORKSPACE}" || (echo "âŒ Workspace not generated: ${XCODE_WORKSPACE}" && exit 2)

      - name: ðŸ§¾ List project targets + schemes
        shell: bash
        run: |
          set -euo pipefail
          echo "### xcodebuild -list (project)" | tee xcode_list_project.txt
          xcodebuild -list -project "${XCODE_PROJECT}" | tee -a xcode_list_project.txt

          echo "### xcodebuild -list (workspace)" | tee xcode_list_workspace.txt
          xcodebuild -list -workspace "${XCODE_WORKSPACE}" | tee -a xcode_list_workspace.txt

      - name: ðŸ§ª Target build-settings matrix (project targets)
        shell: bash
        run: |
          set -euo pipefail

          echo "TARGET,PRODUCT_TYPE,PRODUCT_BUNDLE_IDENTIFIER,SKIP_INSTALL,INSTALL_PATH,INFOPLIST_FILE,OTHER_LDFLAGS" > matrix.csv

          TARGETS=$(xcodebuild -list -project "${XCODE_PROJECT}" | awk '
            $0 ~ /^Targets:/ {in_t=1; next}
            in_t && NF==0 {exit}
            in_t {print $1}
          ')

          if [ -z "${TARGETS:-}" ]; then
            echo "âŒ No targets discovered in project."
            exit 2
          fi

          for T in $TARGETS; do
            echo "Inspecting target: $T"

            SETTINGS=$(xcodebuild \
              -showBuildSettings \
              -project "${XCODE_PROJECT}" \
              -target "$T" \
              -configuration "${CONFIGURATION}" 2>/dev/null || true)

            PT=$(echo "$SETTINGS" | awk -F' = ' '/^ *PRODUCT_TYPE/ {print $2; exit}')
            BID=$(echo "$SETTINGS" | awk -F' = ' '/^ *PRODUCT_BUNDLE_IDENTIFIER/ {print $2; exit}')
            SKIP=$(echo "$SETTINGS" | awk -F' = ' '/^ *SKIP_INSTALL/ {print $2; exit}')
            IP=$(echo "$SETTINGS" | awk -F' = ' '/^ *INSTALL_PATH/ {print $2; exit}')
            PLIST=$(echo "$SETTINGS" | awk -F' = ' '/^ *INFOPLIST_FILE/ {print $2; exit}')
            LDFLAGS=$(echo "$SETTINGS" | awk -F' = ' '/^ *OTHER_LDFLAGS/ {print $2; exit}')

            PT=${PT//,/;}
            BID=${BID//,/;}
            SKIP=${SKIP//,/;}
            IP=${IP//,/;}
            PLIST=${PLIST//,/;}
            LDFLAGS=${LDFLAGS//,/;}

            echo "$T,$PT,$BID,$SKIP,$IP,$PLIST,$LDFLAGS" >> matrix.csv
          done

          column -s, -t matrix.csv | tee matrix.txt || true

      - name: ðŸ”Ž Find application targets (project)
        shell: bash
        run: |
          set -euo pipefail
          echo "### Application targets (PRODUCT_TYPE=application)" | tee app_targets.txt
          grep "com.apple.product-type.application" matrix.csv | tee -a app_targets.txt || true

          COUNT=$(grep -c "com.apple.product-type.application" matrix.csv || true)
          echo "Found $COUNT application target(s)" | tee -a app_targets.txt

      # âœ… NEW: scan schemes and reject anything that is not an iOS application
      - name: ðŸ§  Find an iOS application scheme (workspace schemes)
        id: pick
        shell: bash
        run: |
          set -euo pipefail

          echo "### DESTINATIONS (workspace)" | tee destinations.txt
          xcodebuild -showdestinations \
            -workspace "${XCODE_WORKSPACE}" \
            -scheme "JunoNative" 2>&1 | tee -a destinations.txt || true

          SCHEMES=$(xcodebuild -list -workspace "${XCODE_WORKSPACE}" | awk '
            $0 ~ /^Schemes:/ {in_s=1; next}
            in_s && NF==0 {exit}
            in_s {print $1}
          ')

          if [ -z "${SCHEMES:-}" ]; then
            echo "âŒ No schemes found in workspace."
            exit 2
          fi

          PICKED=""
          for S in $SCHEMES; do
            echo "Checking scheme: $S" | tee -a schemes_scanned.txt

            SETTINGS=$(xcodebuild -showBuildSettings \
              -workspace "${XCODE_WORKSPACE}" \
              -scheme "$S" \
              -configuration "${CONFIGURATION}" 2>/dev/null || true)

            PT=$(echo "$SETTINGS" | awk -F' = ' '/^ *PRODUCT_TYPE/ {print $2; exit}')
            SDK=$(echo "$SETTINGS" | awk -F' = ' '/^ *SDKROOT/ {print $2; exit}')
            SUPPORTS_MACCAT=$(echo "$SETTINGS" | awk -F' = ' '/^ *SUPPORTS_MACCATALYST/ {print $2; exit}')
            SKIP=$(echo "$SETTINGS" | awk -F' = ' '/^ *SKIP_INSTALL/ {print $2; exit}')

            echo "  PRODUCT_TYPE=$PT SDKROOT=$SDK SUPPORTS_MACCATALYST=$SUPPORTS_MACCAT SKIP_INSTALL=$SKIP" | tee -a schemes_scanned.txt

            # Must be an app
            if [ "$PT" != "com.apple.product-type.application" ]; then
              continue
            fi

            # Must be iphoneos (not macos/catalyst-only)
            if [ "$SDK" != "iphoneos" ] && [ "$SDK" != "iphoneos18.0" ] && [ "$SDK" != "iphoneos18.1" ]; then
              # SDKROOT often resolves to "iphoneos" or "iphoneosXX.X" depending on Xcode
              # This check allows both styles but rejects macos/maccatalyst
              case "$SDK" in
                iphoneos* ) ;;
                * ) continue ;;
              esac
            fi

            # Must not be skip-install YES (apps should be NO)
            if [ "$SKIP" = "YES" ]; then
              continue
            fi

            PICKED="$S"
            break
          done

          echo "SCHEMES=$SCHEMES" | tee schemes_all.txt
          echo "PICKED_SCHEME=$PICKED" | tee picked_scheme.txt
          echo "picked_scheme=$PICKED" >> "$GITHUB_OUTPUT"

          if [ -z "$PICKED" ]; then
            echo "âŒ No iOS application scheme found in workspace."
            echo "This usually means your scheme 'JunoNative' points at a static library / framework target."
            exit 2
          fi

      # âœ… NEW: hard assertion for the chosen scheme
      - name: ðŸ”’ Assert picked scheme is an application
        shell: bash
        run: |
          set -euo pipefail
          SCHEME="${{ steps.pick.outputs.picked_scheme }}"

          SETTINGS=$(xcodebuild \
            -workspace "${XCODE_WORKSPACE}" \
            -scheme "$SCHEME" \
            -configuration "${CONFIGURATION}" \
            -showBuildSettings)

          PT=$(echo "$SETTINGS" | awk -F' = ' '/^ *PRODUCT_TYPE/ {print $2; exit}')
          echo "PRODUCT_TYPE=$PT" | tee scheme_product_type.txt

          if [ "$PT" != "com.apple.product-type.application" ]; then
            echo "âŒ Picked scheme '$SCHEME' is not an application."
            exit 2
          fi

      - name: ðŸ—ï¸ Attempt unsigned archive (for structure verification)
        shell: bash
        run: |
          set -euo pipefail
          ARCHIVE_PATH="$RUNNER_TEMP/JunoNative_Forensics.xcarchive"
          rm -rf "$ARCHIVE_PATH"

          SCHEME="${{ steps.pick.outputs.picked_scheme }}"
          echo "Archiving scheme: $SCHEME" | tee archive_attempt.txt

          set +o pipefail
          xcodebuild \
            -workspace "${XCODE_WORKSPACE}" \
            -scheme "$SCHEME" \
            -configuration "${CONFIGURATION}" \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -archivePath "$ARCHIVE_PATH" \
            CODE_SIGNING_ALLOWED=NO \
            archive 2>&1 | tee xcodebuild_archive_raw.log | xcpretty
          XC=${PIPESTATUS[0]}
          set -o pipefail

          echo "xcodebuild exit code: $XC" | tee -a archive_attempt.txt
          if [ "$XC" -ne 0 ]; then
            echo "âŒ Archive failed (unsigned)."
            exit $XC
          fi

          echo "Archive tree:" | tee archive_tree.txt
          find "$ARCHIVE_PATH" -maxdepth 4 -print | tee -a archive_tree.txt

          if [ ! -d "$ARCHIVE_PATH/Products/Applications" ]; then
            echo "âŒ Missing Products/Applications => Generic Archive" | tee -a archive_attempt.txt
            exit 2
          fi

          APP_PATH=$(find "$ARCHIVE_PATH/Products/Applications" -maxdepth 1 -name "*.app" -print -quit || true)
          if [ -z "$APP_PATH" ]; then
            echo "âŒ Products/Applications exists but contains no .app => Still a bad archive" | tee -a archive_attempt.txt
            exit 2
          fi

          echo "âœ… App found: $APP_PATH" | tee -a archive_attempt.txt
          ls -la "$ARCHIVE_PATH/Products/Applications" | tee -a archive_attempt.txt

      - name: ðŸ“Ž Upload forensic artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-forensics
          path: |
            xcode_list_project.txt
            xcode_list_workspace.txt
            matrix.csv
            matrix.txt
            app_targets.txt
            schemes_all.txt
            schemes_scanned.txt
            picked_scheme.txt
            scheme_product_type.txt
            destinations.txt
            archive_attempt.txt
            archive_tree.txt
            xcodebuild_archive_raw.log
