name: iOS Forensic Analysis

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  analyze-ios-project:
    runs-on: macos-15

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode 16
        run: |
          sudo xcode-select -s /Applications/Xcode_16.app
          xcodebuild -version

      - name: Install Ruby tools
        run: |
          gem install cocoapods --no-document
          gem install xcpretty --no-document

      - name: Install JS deps
        run: |
          node -v
          npm ci

      - name: Generate workspace
        run: |
          cd ios
          pod install --repo-update

      - name: Enumerate targets
        run: |
          xcodebuild -list -project ios/JunoNative.xcodeproj

      - name: Target product-type matrix
        run: |
          echo "TARGET,PRODUCT_TYPE,SKIP_INSTALL" > matrix.csv
          for T in $(xcodebuild -list -project ios/JunoNative.xcodeproj | awk '/Targets:/,/^$/' | sed '1d'); do
            SETTINGS=$(xcodebuild -showBuildSettings -project ios/JunoNative.xcodeproj -target "$T" -configuration Release)
            PT=$(echo "$SETTINGS" | awk -F' = ' '/PRODUCT_TYPE/ {print $2; exit}')
            SKIP=$(echo "$SETTINGS" | awk -F' = ' '/SKIP_INSTALL/ {print $2; exit}')
            echo "$T,$PT,$SKIP" >> matrix.csv
          done
          column -s, -t matrix.csv | tee matrix.txt

      - name: Assert application target exists
        run: |
          if ! grep -q "com.apple.product-type.application" matrix.csv; then
            echo "‚ùå No application target found"
            exit 2
          fi

      - name: Upload forensic artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-forensics
          path: |
            matrix.csv
            matrix.txt
