name: iOS CI & Native Artifact Release

on:
  push:
    branches:
      - main
    tags:
      - "ios-v*"
  workflow_dispatch:

jobs:
  build-and-release-ios:
    runs-on: macos-14

    env:
      MATCH_KEYCHAIN_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD }}
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
      APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}

      # App Store Connect API key (base64-encoded p8)
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}

      # Optional for match / keychain if you use it later
      MATCH_KEYCHAIN_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD }}

      # IPA name from Fastlane
      IOS_OUTPUT_NAME: JunoNative.ipa

    steps:
      - name: ðŸ§¾ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: ðŸ’Ž Setup Ruby & Bundler
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: ðŸ“¦ Install JS dependencies
        run: npm ci

      # Optional safety / quality steps â€“ keep or remove as you like
      - name: ðŸ§ª Validate package.json
        run: |
          if [ -f scripts/validate-package-json.js ]; then
            node scripts/validate-package-json.js
          else
            echo "No validate-package-json script, skipping."
          fi

      - name: ðŸ§¹ Lint code
        run: |
          if npm run | grep -q "lint"; then
            npm run lint
          else
            echo "No lint script, skipping."
          fi

      - name: âš™ï¸ Compile TurboModules
        run: |
          if [ -f scripts/compile-turbo-modules.sh ]; then
            bash scripts/compile-turbo-modules.sh
          else
            echo "No compile-turbo-modules.sh, skipping."
          fi

      - name: ðŸ« Install CocoaPods
        run: bundle exec pod install
        working-directory: ios

      - name: ðŸ” Setup signing with Fastlane Match
        run: bundle exec fastlane match appstore --readonly
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD }}

      - name: ðŸ› ï¸ Build iOS archive
        run: |
          ARCHIVE_PATH="$RUNNER_TEMP/JunoNative.xcarchive"

          xcodebuild archive \
            -workspace ios/JunoNative.xcworkspace \
            -scheme JunoNative \
            -sdk iphoneos \
            -configuration Release \
            -archivePath "$ARCHIVE_PATH" \
            -allowProvisioningUpdates

          echo "ARCHIVE_PATH=$ARCHIVE_PATH" >> "$GITHUB_ENV"

      - name: ðŸ“¦ Export .ipa (optional for later use)
        run: |
          ARCHIVE_PATH="${ARCHIVE_PATH:-$RUNNER_TEMP/JunoNative.xcarchive}"
          EXPORT_DIR="$RUNNER_TEMP/output"

          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$EXPORT_DIR" \
            -exportOptionsPlist ios/exportOptions.plist

          echo "EXPORT_DIR=$EXPORT_DIR" >> "$GITHUB_ENV"

      - name: ðŸ” Capture exported artifact paths
        run: |
          set -euo pipefail

          EXPORT_DIR="${EXPORT_DIR:-$RUNNER_TEMP/output}"

          IPA_PATH=$(find "$EXPORT_DIR" -maxdepth 2 -type f -name "*.ipa" -print -quit)
          if [ -n "$IPA_PATH" ]; then
            echo "IPA_PATH=$IPA_PATH" >> "$GITHUB_ENV"
            echo "Found IPA at $IPA_PATH"
          else
            echo "No IPA found in $EXPORT_DIR"
          fi

          DSYM_DIR=$(find "$EXPORT_DIR" -maxdepth 3 -type d -name "*.app.dSYM" -print -quit)
          if [ -n "$DSYM_DIR" ]; then
            echo "DSYM_DIR=$DSYM_DIR" >> "$GITHUB_ENV"
            echo "Found dSYM at $DSYM_DIR"
          else
            echo "No dSYM found in $EXPORT_DIR"
          fi

          ARCHIVE_PATH="${ARCHIVE_PATH:-$(find "$RUNNER_TEMP" -maxdepth 2 -type d -name "*.xcarchive" -print -quit)}"
          if [ -n "$ARCHIVE_PATH" ]; then
            echo "ARCHIVE_PATH=$ARCHIVE_PATH" >> "$GITHUB_ENV"
            echo "Using archive path $ARCHIVE_PATH"
          else
            echo "âŒ Archive path not found"
            exit 1
          fi

      - name: ðŸš€ Upload to TestFlight
        run: bundle exec fastlane release
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}

      - name: ðŸ“‚ Copy compiled native artifacts
        run: |
          set -euo pipefail
          mkdir -p ios_artifacts

          ARCHIVE_PATH="${ARCHIVE_PATH:-$(find "$RUNNER_TEMP" -maxdepth 2 -type d -name "*.xcarchive" -print -quit)}"

          FOUND_LIB=$(find "$ARCHIVE_PATH" -name "libJunoNative.a" -print -quit)

          if [ -z "$FOUND_LIB" ]; then
            echo "âŒ libJunoNative.a not found in archive contents"
            exit 1
          fi

          echo "âœ… Found static lib: $FOUND_LIB"
          cp "$FOUND_LIB" ios_artifacts/

          # Optional: include headers if you expose them
          if ls ios/JunoNative/NativeModules/*.h >/dev/null 2>&1; then
            mkdir -p ios_artifacts/headers
            cp ios/JunoNative/NativeModules/*.h ios_artifacts/headers/
          else
            echo "No NativeModules headers found, skipping."
          fi

      - name: ðŸ’¾ Commit and push artifacts
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git fetch origin ios-artifacts || true
          if git show-ref --verify --quiet refs/remotes/origin/ios-artifacts; then
            git checkout -B ios-artifacts origin/ios-artifacts
          else
            git checkout -B ios-artifacts
          fi
          git add ios_artifacts
          git commit -m "Add compiled native iOS libs for Expo testing [skip ci]" || echo "No changes to commit"
          git push --force-with-lease origin ios-artifacts
