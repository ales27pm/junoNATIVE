name: iOS â€“ TestFlight release
on:
  workflow_dispatch:
  push:
    tags: ["v*"]           # build only on version tags â€“ tweak as you like

jobs:
  release:
    runs-on: macos-14  # Apple Silicon runners are ~2Ã— faster
    timeout-minutes: 60

    # -----------------------------
    # â‘   Export all secrets once
    # -----------------------------
    env:
      APPLE_ID:                       ${{ secrets.APPLE_ID }}
      APP_IDENTIFIER:                 ${{ secrets.APP_IDENTIFIER }}
      APPLE_TEAM_ID:                  ${{ secrets.APPLE_TEAM_ID }}
      APP_STORE_CONNECT_API_KEY_ID:   ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_API_ISSUER_ID:  ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_BASE64:  ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
      IOS_DIST_CERT_BASE64:           ${{ secrets.IOS_DIST_CERT_BASE64 }}
      IOS_DIST_CERT_PASSWORD:         ${{ secrets.IOS_DIST_CERT_PASSWORD }}
      KEYCHAIN_PASSWORD:              ${{ secrets.KEYCHAIN_PASSWORD }}

    steps:
      - name: ðŸ§¾ Checkout
        uses: actions/checkout@v4

      - name: ðŸ›  Set up Ruby & Bundler cache
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      # -----------------------------
      # â‘¡  Import cert & profile
      #     (same trick as verify action)
      # -----------------------------
      - name: ðŸ” Install certificate & provisioning profile
        run: |
          CERT_PATH=$RUNNER_TEMP/dist.p12
          echo "$IOS_DIST_CERT_BASE64" | base64 --decode > "$CERT_PATH"

          KEYCHAIN=$RUNNER_TEMP/build.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security import "$CERT_PATH" -P "$IOS_DIST_CERT_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security list-keychain -d user -s "$KEYCHAIN"

      # -----------------------------
      # â‘¢  Build & upload
      # -----------------------------
      - name: ðŸš€ Fastlane â€“ build & TestFlight upload
        run: bundle exec fastlane ios ios_ci

      # -----------------------------
      # â‘£  Clean-up (optional)
      # -----------------------------
      - name: ðŸ§¹ Cleanup keychain
        if: ${{ always() }}
        run: |
          security delete-keychain "$RUNNER_TEMP/build.keychain-db" || true
