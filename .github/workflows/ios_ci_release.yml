name: iOS CI → TestFlight

on:
  push:
    branches: [main]     # change if you release from another branch
  workflow_dispatch:     # allow manual runs

jobs:
  ios-release:
    runs-on: macos-14-arm64      # Apple Silicon runner, fastest for RN pods
    timeout-minutes: 60

    env:                         # ✨ ALL secrets come from GitHub-Actions secrets
      APPLE_ID:                      ${{ secrets.APPLE_ID }}
      APP_IDENTIFIER:                ${{ secrets.APP_IDENTIFIER }}
      APPLE_TEAM_ID:                 ${{ secrets.APPLE_TEAM_ID }}
      APP_STORE_CONNECT_API_KEY_ID:  ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_API_ISSUER_ID:  ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
      IOS_DIST_CERT_BASE64:          ${{ secrets.IOS_DIST_CERT_BASE64 }}
      IOS_DIST_CERT_PASSWORD:        ${{ secrets.IOS_DIST_CERT_PASSWORD }}
      # optional / nice-to-have
      APP_APPLE_ID:                  ${{ secrets.APP_APPLE_ID }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Ruby 3.3 + Bundler cache
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true            # Gemfile.lock drives the cache

      - name: Run iOS CI lane (fastlane ios_ci)
        run: bundle exec fastlane ios_ci

      # ⬆️  if the lane completes, your build is already uploaded to TF
