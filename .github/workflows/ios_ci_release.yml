name: iOS CI & Native Artifact Release

on:
  push:
    branches:
      - main
    tags:
      - "ios-v*"
  workflow_dispatch:

jobs:
  build-and-release-ios:
    runs-on: macos-14

    env:
      # Apple account / app metadata
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}

      # App Store Connect API key (base64-encoded p8)
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}

      # Optional for match / keychain if you use it later
      MATCH_KEYCHAIN_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD }}

      # IPA name used by Fastlane
      IOS_OUTPUT_NAME: JunoNative.ipa

    steps:
      - name: ðŸ§¾ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: ðŸ’Ž Setup Ruby & Bundler
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: ðŸ“¦ Install JS dependencies
        run: npm ci

      - name: ðŸ§ª Validate package.json (optional)
        run: |
          if [ -f scripts/validate-package-json.js ]; then
            node scripts/validate-package-json.js
          else
            echo "No validate-package-json script, skipping."
          fi

      - name: ðŸ§¹ Lint code (optional)
        run: |
          if npm run | grep -q "lint"; then
            npm run lint
          else
            echo "No lint script, skipping."
          fi

      - name: âš™ï¸ Compile TurboModules (optional but recommended)
        run: |
          if [ -f scripts/compile-turbo-modules.sh ]; then
            bash scripts/compile-turbo-modules.sh
          else
            echo "No scripts/compile-turbo-modules.sh, skipping."
          fi

      - name: ðŸ« Install CocoaPods
        run: bundle exec pod install
        working-directory: ios

      - name: ðŸš€ Build & upload iOS app via Fastlane (ios_ci lane)
        run: |
          bundle exec fastlane ios ios_ci

      - name: ðŸ“‚ Copy compiled native artifacts
        run: |
          set -euo pipefail
          mkdir -p ios_artifacts

          DERIVED_PATH="$HOME/Library/Developer/Xcode/DerivedData"

          # Try to find libJunoNative.a first
          FOUND_LIB=$(find "$DERIVED_PATH" -name "libJunoNative.a" -print -quit || true)

          # Fallback: try libjuno_engine.a from the C++ core
          if [ -z "$FOUND_LIB" ]; then
            FOUND_LIB=$(find "$DERIVED_PATH" -name "libjuno_engine.a" -print -quit || true)
          fi

          if [ -z "$FOUND_LIB" ]; then
            echo "âŒ No static library found (libJunoNative.a or libjuno_engine.a) in DerivedData"
            exit 1
          fi

          echo "âœ… Found static lib: $FOUND_LIB"
          cp "$FOUND_LIB" ios_artifacts/

          # Optional: include headers if they exist
          if ls ios/JunoNative/NativeModules/*.h >/dev/null 2>&1; then
            mkdir -p ios_artifacts/headers
            cp ios/JunoNative/NativeModules/*.h ios_artifacts/headers/
          else
            echo "No NativeModules headers found, skipping."
          fi

      - name: ðŸ’¾ Commit and push artifacts
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add ios_artifacts || true
          git commit -m "Add compiled native iOS libs for Expo testing [skip ci]" || echo "No changes to commit"
          git push || echo "No changes to push"
