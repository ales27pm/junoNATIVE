name: iOS CI & TestFlight Release

on:
  push:
    branches: [ "main" ]
    tags: [ "ios-v*" ]
  workflow_dispatch:

jobs:
  build-and-release-ios:
    runs-on: macos-14

    env:
      # App metadata
      APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      # App Store Connect credentials
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}

      # Manual signing inputs
      IOS_DIST_CERT_BASE64: ${{ secrets.IOS_DIST_CERT_BASE64 }}
      IOS_DIST_CERT_PASSWORD: ${{ secrets.IOS_DIST_CERT_PASSWORD }}
      IOS_PROFILE_BASE64: ${{ secrets.IOS_PROFILE_BASE64 }}

      MATCH_KEYCHAIN_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD }}
      KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      CI: "true"

    steps:
      - name: üßæ Checkout source
        uses: actions/checkout@v4

      - name: üìÇ Ensure ios directory exists
        shell: bash
        run: |
          set -e
          if [ ! -d "ios" ]; then
            echo "‚öôÔ∏è Creating ios directory (required for CocoaPods)"
            mkdir ios
          fi
          ls -la ios || true

      - name: üç∫ Install dependencies (XcodeGen + CocoaPods)
        shell: bash
        run: |
          set -euxo pipefail
          brew update
          brew install xcodegen cocoapods
          which xcodegen
          xcodegen version
          pod --version

      - name: üü¢ Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn

      - name: üß∞ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      - name: üì¶ Install JS dependencies
        shell: bash
        run: |
          set -euxo pipefail
          corepack enable
          yarn install --frozen-lockfile || yarn install

      - name: üß± Verify system versions
        run: |
          echo "Node $(node -v)"
          echo "Ruby $(ruby -v)"
          echo "Xcode version:"
          xcodebuild -version
          echo "SDKs:"
          xcodebuild -showsdks | head -n 20

      - name: üöÄ Build + Upload TestFlight (Fastlane)
        shell: bash
        run: |
          set -euo pipefail
          echo "Running Fastlane iOS CI..."
          bundle exec fastlane ios ios_ci
