name: iOS CI & Native Artifact Release

on:
  push:
    branches:
      - main
    tags:
      - "ios-v*"
  workflow_dispatch:

jobs:
  build-and-release-ios:
    runs-on: macos-14

    env:
      MATCH_KEYCHAIN_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD }}
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APPLE_KEY_ID }}
      APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APPLE_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY: ${{ secrets.APPLE_KEY }}
      APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

    steps:
      - name: üßæ Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: üíé Setup Ruby & Bundler
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: üì¶ Install JS dependencies
        run: npm ci

      - name: üß™ Validate package.json
        run: node scripts/validate-package-json.js

      - name: üßπ Lint code
        run: npm run lint

      - name: ‚öôÔ∏è Compile TurboModules
        run: bash scripts/compile-turbo-modules.sh

      - name: üç´ Install CocoaPods
        run: bundle exec pod install
        working-directory: ios

      - name: üîê Setup signing with Fastlane Match
        run: bundle exec fastlane match appstore --readonly
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD }}

      - name: üõ†Ô∏è Build iOS archive
        run: |
          xcodebuild archive \
            -workspace ios/JunoNative.xcworkspace \
            -scheme JunoNative \
            -sdk iphoneos \
            -configuration Release \
            -archivePath $RUNNER_TEMP/JunoNative.xcarchive \
            -allowProvisioningUpdates

      - name: üì¶ Export .ipa (optional for later use)
        run: |
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/JunoNative.xcarchive \
            -exportPath $RUNNER_TEMP/output \
            -exportOptionsPlist ios/exportOptions.plist

      - name: üöÄ Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: ${{ runner.temp }}/output/JunoNative.ipa
          issuer-id: ${{ secrets.APPLE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPLE_KEY_ID }}
          api-private-key: ${{ secrets.APPLE_KEY }}

      - name: üì¶ Zip dSYM
        run: zip -r JunoNative.app.dSYM.zip "$RUNNER_TEMP/output/JunoNative.app.dSYM"

      - name: ‚òÅÔ∏è Upload dSYM to App Store
        run: |
          xcrun altool \
            --upload-symbols \
            -f JunoNative.app.dSYM.zip \
            --type ios \
            --apiKey ${{ secrets.APPLE_KEY_ID }} \
            --apiIssuer ${{ secrets.APPLE_ISSUER_ID }}

      - name: üìÇ Copy compiled native artifacts
        run: |
          set -euo pipefail
          mkdir -p ios_artifacts

          FOUND_LIB=$(find "$RUNNER_TEMP/JunoNative.xcarchive" -name "libJunoNative.a" -print -quit)

          if [ -z "$FOUND_LIB" ]; then
            echo "‚ùå libJunoNative.a not found in archive contents"
            exit 1
          fi

          echo "‚úÖ Found static lib: $FOUND_LIB"
          cp "$FOUND_LIB" ios_artifacts/

          # Optional: include public headers
          mkdir -p ios_artifacts/headers
          cp ios/JunoNative/NativeModules/*.h ios_artifacts/headers/

      - name: üíæ Commit and push artifacts
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git checkout -B ios-artifacts
          git add ios_artifacts
          git commit -m "Add compiled native iOS libs for Expo testing [skip ci]" || echo "No changes to commit"
          git push origin ios-artifacts
